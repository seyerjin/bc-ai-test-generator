"use strict";var xs=Object.create;var ct=Object.defineProperty;var _s=Object.getOwnPropertyDescriptor;var Ts=Object.getOwnPropertyNames;var vs=Object.getPrototypeOf,Es=Object.prototype.hasOwnProperty;var Ss=(n,e)=>{for(var t in e)ct(n,t,{get:e[t],enumerable:!0})},Rr=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Ts(e))!Es.call(n,s)&&s!==t&&ct(n,s,{get:()=>e[s],enumerable:!(r=_s(e,s))||r.enumerable});return n};var L=(n,e,t)=>(t=n!=null?xs(vs(n)):{},Rr(e||!n||!n.__esModule?ct(t,"default",{value:n,enumerable:!0}):t,n)),Cs=n=>Rr(ct({},"__esModule",{value:!0}),n);var yn={};Ss(yn,{activate:()=>un,deactivate:()=>bn});module.exports=Cs(yn);var m=L(require("vscode"));var X=class n{constructor(e){this.API_KEY_SECRET="anthropic_api_key";this.secretStorage=e.secrets}static initialize(e){if(n._instance)throw new Error("AuthService bereits initialisiert");n._instance=new n(e)}static get instance(){if(!n._instance)throw new Error("AuthService nicht initialisiert. Rufe initialize() in activate() auf.");return n._instance}async storeApiKey(e){if(!e||typeof e!="string")throw new Error("API-Key darf nicht leer sein");if(!e.startsWith("sk-ant-"))throw new Error('Ung\xFCltiges API-Key Format. Anthropic Keys beginnen mit "sk-ant-"');if(e.length<30)throw new Error("API-Key zu kurz. Bitte vollst\xE4ndigen Key eingeben");await this.secretStorage.store(this.API_KEY_SECRET,e)}async getApiKey(){return await this.secretStorage.get(this.API_KEY_SECRET)}async hasApiKey(){let e=await this.getApiKey();return e!==void 0&&e.length>0}async deleteApiKey(){await this.secretStorage.delete(this.API_KEY_SECRET)}static validateKeyFormat(e){return!e||typeof e!="string"?!1:/^sk-ant-[a-zA-Z0-9-_]{30,}$/.test(e)}async getMaskedApiKey(){let e=await this.getApiKey();if(!e)return"Not configured";if(e.length<10)return"***";let t=e.substring(0,7),r=e.substring(e.length-3);return`${t}***${r}`}};function d(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t}function c(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)}var zt=function(){let{crypto:n}=globalThis;if(n?.randomUUID)return zt=n.randomUUID.bind(n),n.randomUUID();let e=new Uint8Array(1),t=n?()=>n.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,r=>(+r^t()&15>>+r/4).toString(16))};function W(n){return typeof n=="object"&&n!==null&&("name"in n&&n.name==="AbortError"||"message"in n&&String(n.message).includes("FetchRequestCanceledException"))}var Fe=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null){try{if(Object.prototype.toString.call(n)==="[object Error]"){let e=new Error(n.message,n.cause?{cause:n.cause}:{});return n.stack&&(e.stack=n.stack),n.cause&&!e.cause&&(e.cause=n.cause),n.name&&(e.name=n.name),e}}catch{}try{return new Error(JSON.stringify(n))}catch{}}return new Error(n)};var h=class extends Error{},v=class n extends h{constructor(e,t,r,s){super(`${n.makeMessage(e,t,r)}`),this.status=e,this.headers=s,this.requestID=s?.get("request-id"),this.error=t}static makeMessage(e,t,r){let s=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,r,s){if(!e||!s)return new Y({message:r,cause:Fe(t)});let i=t;return e===400?new me(e,i,r,s):e===401?new fe(e,i,r,s):e===403?new ge(e,i,r,s):e===404?new be(e,i,r,s):e===409?new ye(e,i,r,s):e===422?new we(e,i,r,s):e===429?new xe(e,i,r,s):e>=500?new _e(e,i,r,s):new n(e,i,r,s)}},S=class extends v{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},Y=class extends v{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},he=class extends Y{constructor({message:e}={}){super({message:e??"Request timed out."})}},me=class extends v{},fe=class extends v{},ge=class extends v{},be=class extends v{},ye=class extends v{},we=class extends v{},xe=class extends v{},_e=class extends v{};var As=/^[a-z][a-z0-9+.-]*:/i,kr=n=>As.test(n),Jt=n=>(Jt=Array.isArray,Jt(n)),Xt=Jt;function lt(n){return typeof n!="object"?{}:n??{}}function Ir(n){if(!n)return!0;for(let e in n)return!1;return!0}function Lr(n,e){return Object.prototype.hasOwnProperty.call(n,e)}var Nr=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new h(`${n} must be an integer`);if(e<0)throw new h(`${n} must be a positive integer`);return e};var ut=n=>{try{return JSON.parse(n)}catch{return}};var Or=n=>new Promise(e=>setTimeout(e,n));var Q="0.71.2";var Ur=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function Ps(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}var Rs=()=>{let n=Ps();if(n==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Q,"X-Stainless-OS":Dr(Deno.build.os),"X-Stainless-Arch":$r(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Q,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(n==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Q,"X-Stainless-OS":Dr(globalThis.process.platform??"unknown"),"X-Stainless-Arch":$r(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};let e=ks();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Q,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Q,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function ks(){if(typeof navigator>"u"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let r=t.exec(navigator.userAgent);if(r){let s=r[1]||0,i=r[2]||0,o=r[3]||0;return{browser:e,version:`${s}.${i}.${o}`}}}return null}var $r=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Dr=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),Fr,Br=()=>Fr??(Fr=Rs());function jr(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new Anthropic({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function Yt(...n){let e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...n)}function dt(n){let e=Symbol.asyncIterator in n?n[Symbol.asyncIterator]():n[Symbol.iterator]();return Yt({start(){},async pull(t){let{done:r,value:s}=await e.next();r?t.close():t.enqueue(s)},async cancel(){await e.return?.()}})}function Ue(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function qr(n){if(n===null||typeof n!="object")return;if(n[Symbol.asyncIterator]){await n[Symbol.asyncIterator]().return?.();return}let e=n.getReader(),t=e.cancel();e.releaseLock(),await t}var Hr=({headers:n,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)});function Gr(n){let e=0;for(let s of n)e+=s.length;let t=new Uint8Array(e),r=0;for(let s of n)t.set(s,r),r+=s.length;return t}var Wr;function Be(n){let e;return(Wr??(e=new globalThis.TextEncoder,Wr=e.encode.bind(e)))(n)}var Vr;function Qt(n){let e;return(Vr??(e=new globalThis.TextDecoder,Vr=e.decode.bind(e)))(n)}var R,k,V=class{constructor(){R.set(this,void 0),k.set(this,void 0),d(this,R,new Uint8Array,"f"),d(this,k,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?Be(e):e;d(this,R,Gr([c(this,R,"f"),t]),"f");let r=[],s;for(;(s=Ns(c(this,R,"f"),c(this,k,"f")))!=null;){if(s.carriage&&c(this,k,"f")==null){d(this,k,s.index,"f");continue}if(c(this,k,"f")!=null&&(s.index!==c(this,k,"f")+1||s.carriage)){r.push(Qt(c(this,R,"f").subarray(0,c(this,k,"f")-1))),d(this,R,c(this,R,"f").subarray(c(this,k,"f")),"f"),d(this,k,null,"f");continue}let i=c(this,k,"f")!==null?s.preceding-1:s.preceding,o=Qt(c(this,R,"f").subarray(0,i));r.push(o),d(this,R,c(this,R,"f").subarray(s.index),"f"),d(this,k,null,"f")}return r}flush(){return c(this,R,"f").length?this.decode(`
`):[]}};R=new WeakMap,k=new WeakMap;V.NEWLINE_CHARS=new Set([`
`,"\r"]);V.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Ns(n,e){for(let s=e??0;s<n.length;s++){if(n[s]===10)return{preceding:s,index:s+1,carriage:!1};if(n[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function Kr(n){for(let r=0;r<n.length-1;r++){if(n[r]===10&&n[r+1]===10||n[r]===13&&n[r+1]===13)return r+2;if(n[r]===13&&n[r+1]===10&&r+3<n.length&&n[r+2]===13&&n[r+3]===10)return r+4}return-1}var ht={off:0,error:200,warn:300,info:400,debug:500},Zt=(n,e,t)=>{if(n){if(Lr(ht,n))return n;E(t).warn(`${e} was set to ${JSON.stringify(n)}, expected one of ${JSON.stringify(Object.keys(ht))}`)}};function je(){}function pt(n,e,t){return!e||ht[n]>ht[t]?je:e[n].bind(e)}var Os={error:je,warn:je,info:je,debug:je},zr=new WeakMap;function E(n){let e=n.logger,t=n.logLevel??"off";if(!e)return Os;let r=zr.get(e);if(r&&r[0]===t)return r[1];let s={error:pt("error",e,t),warn:pt("warn",e,t),info:pt("info",e,t),debug:pt("debug",e,t)};return zr.set(e,[t,s]),s}var G=n=>(n.options&&(n.options={...n.options},delete n.options.headers),n.headers&&(n.headers=Object.fromEntries((n.headers instanceof Headers?[...n.headers]:Object.entries(n.headers)).map(([e,t])=>[e,e.toLowerCase()==="x-api-key"||e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in n&&(n.retryOfRequestLogID&&(n.retryOf=n.retryOfRequestLogID),delete n.retryOfRequestLogID),n);var qe,B=class n{constructor(e,t,r){this.iterator=e,qe.set(this,void 0),this.controller=t,d(this,qe,r,"f")}static fromSSEResponse(e,t,r){let s=!1,i=r?E(r):console;async function*o(){if(s)throw new h("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let a=!1;try{for await(let l of $s(e,t)){if(l.event==="completion")try{yield JSON.parse(l.data)}catch(u){throw i.error("Could not parse message into JSON:",l.data),i.error("From chunk:",l.raw),u}if(l.event==="message_start"||l.event==="message_delta"||l.event==="message_stop"||l.event==="content_block_start"||l.event==="content_block_delta"||l.event==="content_block_stop")try{yield JSON.parse(l.data)}catch(u){throw i.error("Could not parse message into JSON:",l.data),i.error("From chunk:",l.raw),u}if(l.event!=="ping"&&l.event==="error")throw new v(void 0,ut(l.data)??l.data,void 0,e.headers)}a=!0}catch(l){if(W(l))return;throw l}finally{a||t.abort()}}return new n(o,t,r)}static fromReadableStream(e,t,r){let s=!1;async function*i(){let a=new V,l=Ue(e);for await(let u of l)for(let p of a.decode(u))yield p;for(let u of a.flush())yield u}async function*o(){if(s)throw new h("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let a=!1;try{for await(let l of i())a||l&&(yield JSON.parse(l));a=!0}catch(l){if(W(l))return;throw l}finally{a||t.abort()}}return new n(o,t,r)}[(qe=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),s=i=>({next:()=>{if(i.length===0){let o=r.next();e.push(o),t.push(o)}return i.shift()}});return[new n(()=>s(e),this.controller,c(this,qe,"f")),new n(()=>s(t),this.controller,c(this,qe,"f"))]}toReadableStream(){let e=this,t;return Yt({async start(){t=e[Symbol.asyncIterator]()},async pull(r){try{let{value:s,done:i}=await t.next();if(i)return r.close();let o=Be(JSON.stringify(s)+`
`);r.enqueue(o)}catch(s){r.error(s)}},async cancel(){await t.return?.()}})}};async function*$s(n,e){if(!n.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new h("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new h("Attempted to iterate over a response with no body");let t=new er,r=new V,s=Ue(n.body);for await(let i of Ds(s))for(let o of r.decode(i)){let a=t.decode(o);a&&(yield a)}for(let i of r.flush()){let o=t.decode(i);o&&(yield o)}}async function*Ds(n){let e=new Uint8Array;for await(let t of n){if(t==null)continue;let r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?Be(t):t,s=new Uint8Array(e.length+r.length);s.set(e),s.set(r,e.length),e=s;let i;for(;(i=Kr(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}var er=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,s]=Fs(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}};function Fs(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}async function mt(n,e){let{response:t,requestLogID:r,retryOfRequestLogID:s,startTime:i}=e,o=await(async()=>{if(e.options.stream)return E(n).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):B.fromSSEResponse(t,e.controller);if(t.status===204)return null;if(e.options.__binaryResponse)return t;let l=t.headers.get("content-type")?.split(";")[0]?.trim();if(l?.includes("application/json")||l?.endsWith("+json")){let y=await t.json();return tr(y,t)}return await t.text()})();return E(n).debug(`[${r}] response parsed`,G({retryOfRequestLogID:s,url:t.url,status:t.status,body:o,durationMs:Date.now()-i})),o}function tr(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}var He,ne=class n extends Promise{constructor(e,t,r=mt){super(s=>{s(null)}),this.responsePromise=t,this.parseResponse=r,He.set(this,void 0),d(this,He,e,"f")}_thenUnwrap(e){return new n(c(this,He,"f"),this.responsePromise,async(t,r)=>tr(e(await this.parseResponse(t,r),r),r.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(c(this,He,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};He=new WeakMap;var ft,gt=class{constructor(e,t,r,s){ft.set(this,void 0),d(this,ft,e,"f"),this.options=s,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){let e=this.nextPageRequestOptions();if(!e)throw new h("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await c(this,ft,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(ft=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},We=class extends ne{constructor(e,t,r){super(e,t,async(s,i)=>new r(s,i.response,await mt(s,i),i.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},N=class extends gt{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.has_more=r.has_more||!1,this.first_id=r.first_id||null,this.last_id=r.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){if(this.options.query?.before_id){let t=this.first_id;return t?{...this.options,query:{...lt(this.options.query),before_id:t}}:null}let e=this.last_id;return e?{...this.options,query:{...lt(this.options.query),after_id:e}}:null}};var Te=class extends gt{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.has_more=r.has_more||!1,this.next_page=r.next_page||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){let e=this.next_page;return e?{...this.options,query:{...lt(this.options.query),page:e}}:null}};var sr=()=>{if(typeof File>"u"){let{process:n}=globalThis,e=typeof n?.versions?.node=="string"&&parseInt(n.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(e?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function ie(n,e,t){return sr(),new File(n,e??"unknown_file",t)}function Ve(n){return(typeof n=="object"&&n!==null&&("name"in n&&n.name&&String(n.name)||"url"in n&&n.url&&String(n.url)||"filename"in n&&n.filename&&String(n.filename)||"path"in n&&n.path&&String(n.path))||"").split(/[\\/]/).pop()||void 0}var nr=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function";var ve=async(n,e)=>({...n,body:await js(n.body,e)}),Jr=new WeakMap;function Bs(n){let e=typeof n=="function"?n:n.fetch,t=Jr.get(e);if(t)return t;let r=(async()=>{try{let s="Response"in e?e.Response:(await e("data:,")).constructor,i=new FormData;return i.toString()!==await new s(i).text()}catch{return!0}})();return Jr.set(e,r),r}var js=async(n,e)=>{if(!await Bs(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");let t=new FormData;return await Promise.all(Object.entries(n||{}).map(([r,s])=>rr(t,r,s))),t},qs=n=>n instanceof Blob&&"name"in n;var rr=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(t instanceof Response){let r={},s=t.headers.get("Content-Type");s&&(r={type:s}),n.append(e,ie([await t.blob()],Ve(t),r))}else if(nr(t))n.append(e,ie([await new Response(dt(t)).blob()],Ve(t)));else if(qs(t))n.append(e,ie([t],Ve(t),{type:t.type}));else if(Array.isArray(t))await Promise.all(t.map(r=>rr(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,s])=>rr(n,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Xr=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",Hs=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Xr(n),Ws=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function";async function bt(n,e,t){if(sr(),n=await n,e||(e=Ve(n)),Hs(n))return n instanceof File&&e==null&&t==null?n:ie([await n.arrayBuffer()],e??n.name,{type:n.type,lastModified:n.lastModified,...t});if(Ws(n)){let s=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()),ie(await ir(s),e,t)}let r=await ir(n);if(!t?.type){let s=r.find(i=>typeof i=="object"&&"type"in i&&i.type);typeof s=="string"&&(t={...t,type:s})}return ie(r,e,t)}async function ir(n){let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Xr(n))e.push(n instanceof Blob?n:await n.arrayBuffer());else if(nr(n))for await(let t of n)e.push(...await ir(t));else{let t=n?.constructor?.name;throw new Error(`Unexpected data type: ${typeof n}${t?`; constructor: ${t}`:""}${Vs(n)}`)}return e}function Vs(n){return typeof n!="object"||n===null?"":`; props: [${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}var w=class{constructor(e){this._client=e}};var Yr=Symbol.for("brand.privateNullableHeaders");function*Ks(n){if(!n)return;if(Yr in n){let{values:r,nulls:s}=n;yield*r.entries();for(let i of s)yield[i,null];return}let e=!1,t;n instanceof Headers?t=n.entries():Xt(n)?t=n:(e=!0,t=Object.entries(n??{}));for(let r of t){let s=r[0];if(typeof s!="string")throw new TypeError("expected header name to be a string");let i=Xt(r[1])?r[1]:[r[1]],o=!1;for(let a of i)a!==void 0&&(e&&!o&&(o=!0,yield[s,null]),yield[s,a])}}var f=n=>{let e=new Headers,t=new Set;for(let r of n){let s=new Set;for(let[i,o]of Ks(r)){let a=i.toLowerCase();s.has(a)||(e.delete(i),s.add(a)),o===null?(e.delete(i),t.add(a)):(e.append(i,o),t.delete(a))}}return{[Yr]:!0,values:e,nulls:t}};function Zr(n){return n.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}var Qr=Object.freeze(Object.create(null)),zs=(n=Zr)=>function(t,...r){if(t.length===1)return t[0];let s=!1,i=[],o=t.reduce((p,y,M)=>{/[?#]/.test(y)&&(s=!0);let g=r[M],D=(s?encodeURIComponent:n)(""+g);return M!==r.length&&(g==null||typeof g=="object"&&g.toString===Object.getPrototypeOf(Object.getPrototypeOf(g.hasOwnProperty??Qr)??Qr)?.toString)&&(D=g+"",i.push({start:p.length+y.length,length:D.length,error:`Value of type ${Object.prototype.toString.call(g).slice(8,-1)} is not a valid path parameter`})),p+y+(M===r.length?"":D)},""),a=o.split(/[?#]/,1)[0],l=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi,u;for(;(u=l.exec(a))!==null;)i.push({start:u.index,length:u[0].length,error:`Value "${u[0]}" can't be safely passed as a path parameter`});if(i.sort((p,y)=>p.start-y.start),i.length>0){let p=0,y=i.reduce((M,g)=>{let D=" ".repeat(g.start-p),Gt="^".repeat(g.length);return p=g.start+g.length,M+D+Gt},"");throw new h(`Path parameters result in path with invalid segments:
${i.map(M=>M.error).join(`
`)}
${o}
${y}`)}return o},x=zs(Zr);var Ee=class extends w{list(e={},t){let{betas:r,...s}=e??{};return this._client.getAPIList("/v1/files",N,{query:s,...t,headers:f([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString()},t?.headers])})}delete(e,t={},r){let{betas:s}=t??{};return this._client.delete(x`/v1/files/${e}`,{...r,headers:f([{"anthropic-beta":[...s??[],"files-api-2025-04-14"].toString()},r?.headers])})}download(e,t={},r){let{betas:s}=t??{};return this._client.get(x`/v1/files/${e}/content`,{...r,headers:f([{"anthropic-beta":[...s??[],"files-api-2025-04-14"].toString(),Accept:"application/binary"},r?.headers]),__binaryResponse:!0})}retrieveMetadata(e,t={},r){let{betas:s}=t??{};return this._client.get(x`/v1/files/${e}`,{...r,headers:f([{"anthropic-beta":[...s??[],"files-api-2025-04-14"].toString()},r?.headers])})}upload(e,t){let{betas:r,...s}=e;return this._client.post("/v1/files",ve({body:s,...t,headers:f([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString()},t?.headers])},this._client))}};var Se=class extends w{retrieve(e,t={},r){let{betas:s}=t??{};return this._client.get(x`/v1/models/${e}?beta=true`,{...r,headers:f([{...s?.toString()!=null?{"anthropic-beta":s?.toString()}:void 0},r?.headers])})}list(e={},t){let{betas:r,...s}=e??{};return this._client.getAPIList("/v1/models?beta=true",N,{query:s,...t,headers:f([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},t?.headers])})}};var yt={"claude-opus-4-20250514":8192,"claude-opus-4-0":8192,"claude-4-opus-20250514":8192,"anthropic.claude-opus-4-20250514-v1:0":8192,"claude-opus-4@20250514":8192,"claude-opus-4-1-20250805":8192,"anthropic.claude-opus-4-1-20250805-v1:0":8192,"claude-opus-4-1@20250805":8192};function or(n,e,t){return!e||!("parse"in(e.output_format??{}))?{...n,content:n.content.map(r=>{if(r.type==="text"){let s=Object.defineProperty({...r},"parsed_output",{value:null,enumerable:!1});return Object.defineProperty(s,"parsed",{get(){return t.logger.warn("The `parsed` property on `text` blocks is deprecated, please use `parsed_output` instead."),null},enumerable:!1})}return r}),parsed_output:null}:ar(n,e,t)}function ar(n,e,t){let r=null,s=n.content.map(i=>{if(i.type==="text"){let o=Ys(e,i.text);r===null&&(r=o);let a=Object.defineProperty({...i},"parsed_output",{value:o,enumerable:!1});return Object.defineProperty(a,"parsed",{get(){return t.logger.warn("The `parsed` property on `text` blocks is deprecated, please use `parsed_output` instead."),o},enumerable:!1})}return i});return{...n,content:s,parsed_output:r}}function Ys(n,e){if(n.output_format?.type!=="json_schema")return null;try{return"parse"in n.output_format?n.output_format.parse(e):JSON.parse(e)}catch(t){throw new h(`Failed to parse structured output: ${t}`)}}var Qs=n=>{let e=0,t=[];for(;e<n.length;){let r=n[e];if(r==="\\"){e++;continue}if(r==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(r==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(r==="["){t.push({type:"paren",value:"["}),e++;continue}if(r==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(r===":"){t.push({type:"separator",value:":"}),e++;continue}if(r===","){t.push({type:"delimiter",value:","}),e++;continue}if(r==='"'){let a="",l=!1;for(r=n[++e];r!=='"';){if(e===n.length){l=!0;break}if(r==="\\"){if(e++,e===n.length){l=!0;break}a+=r+n[e],r=n[++e]}else a+=r,r=n[++e]}r=n[++e],l||t.push({type:"string",value:a});continue}if(r&&/\s/.test(r)){e++;continue}let i=/[0-9]/;if(r&&i.test(r)||r==="-"||r==="."){let a="";for(r==="-"&&(a+=r,r=n[++e]);r&&i.test(r)||r===".";)a+=r,r=n[++e];t.push({type:"number",value:a});continue}let o=/[a-z]/i;if(r&&o.test(r)){let a="";for(;r&&o.test(r)&&e!==n.length;)a+=r,r=n[++e];if(a=="true"||a=="false"||a==="null")t.push({type:"name",value:a});else{e++;continue}continue}e++}return t},Ce=n=>{if(n.length===0)return n;let e=n[n.length-1];switch(e.type){case"separator":return n=n.slice(0,n.length-1),Ce(n);break;case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return n=n.slice(0,n.length-1),Ce(n);case"string":let r=n[n.length-2];if(r?.type==="delimiter")return n=n.slice(0,n.length-1),Ce(n);if(r?.type==="brace"&&r.value==="{")return n=n.slice(0,n.length-1),Ce(n);break;case"delimiter":return n=n.slice(0,n.length-1),Ce(n);break}return n},Zs=n=>{let e=[];return n.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?n.push({type:"brace",value:"}"}):t==="]"&&n.push({type:"paren",value:"]"})}),n},en=n=>{let e="";return n.map(t=>{t.type==="string"?e+='"'+t.value+'"':e+=t.value}),e},wt=n=>JSON.parse(en(Zs(Ce(Qs(n)))));var O,Z,Me,Ge,xt,Ke,ze,_t,Je,K,Xe,Tt,vt,oe,Et,St,Ye,cr,es,Ct,lr,ur,dr,ts,rs="__json_buf";function ss(n){return n.type==="tool_use"||n.type==="server_tool_use"||n.type==="mcp_tool_use"}var Mt=class n{constructor(e,t){O.add(this),this.messages=[],this.receivedMessages=[],Z.set(this,void 0),Me.set(this,null),this.controller=new AbortController,Ge.set(this,void 0),xt.set(this,()=>{}),Ke.set(this,()=>{}),ze.set(this,void 0),_t.set(this,()=>{}),Je.set(this,()=>{}),K.set(this,{}),Xe.set(this,!1),Tt.set(this,!1),vt.set(this,!1),oe.set(this,!1),Et.set(this,void 0),St.set(this,void 0),Ye.set(this,void 0),Ct.set(this,r=>{if(d(this,Tt,!0,"f"),W(r)&&(r=new S),r instanceof S)return d(this,vt,!0,"f"),this._emit("abort",r);if(r instanceof h)return this._emit("error",r);if(r instanceof Error){let s=new h(r.message);return s.cause=r,this._emit("error",s)}return this._emit("error",new h(String(r)))}),d(this,Ge,new Promise((r,s)=>{d(this,xt,r,"f"),d(this,Ke,s,"f")}),"f"),d(this,ze,new Promise((r,s)=>{d(this,_t,r,"f"),d(this,Je,s,"f")}),"f"),c(this,Ge,"f").catch(()=>{}),c(this,ze,"f").catch(()=>{}),d(this,Me,e,"f"),d(this,Ye,t?.logger??console,"f")}get response(){return c(this,Et,"f")}get request_id(){return c(this,St,"f")}async withResponse(){d(this,oe,!0,"f");let e=await c(this,Ge,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new n(null);return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,r,{logger:s}={}){let i=new n(t,{logger:s});for(let o of t.messages)i._addMessageParam(o);return d(i,Me,{...t,stream:!0},"f"),i._run(()=>i._createMessage(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),i}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},c(this,Ct,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,r){let s=r?.signal,i;s&&(s.aborted&&this.controller.abort(),i=this.controller.abort.bind(this.controller),s.addEventListener("abort",i));try{c(this,O,"m",lr).call(this);let{response:o,data:a}=await e.create({...t,stream:!0},{...r,signal:this.controller.signal}).withResponse();this._connected(o);for await(let l of a)c(this,O,"m",ur).call(this,l);if(a.controller.signal?.aborted)throw new S;c(this,O,"m",dr).call(this)}finally{s&&i&&s.removeEventListener("abort",i)}}_connected(e){this.ended||(d(this,Et,e,"f"),d(this,St,e?.headers.get("request-id"),"f"),c(this,xt,"f").call(this,e),this._emit("connect"))}get ended(){return c(this,Xe,"f")}get errored(){return c(this,Tt,"f")}get aborted(){return c(this,vt,"f")}abort(){this.controller.abort()}on(e,t){return(c(this,K,"f")[e]||(c(this,K,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=c(this,K,"f")[e];if(!r)return this;let s=r.findIndex(i=>i.listener===t);return s>=0&&r.splice(s,1),this}once(e,t){return(c(this,K,"f")[e]||(c(this,K,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{d(this,oe,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){d(this,oe,!0,"f"),await c(this,ze,"f")}get currentMessage(){return c(this,Z,"f")}async finalMessage(){return await this.done(),c(this,O,"m",cr).call(this)}async finalText(){return await this.done(),c(this,O,"m",es).call(this)}_emit(e,...t){if(c(this,Xe,"f"))return;e==="end"&&(d(this,Xe,!0,"f"),c(this,_t,"f").call(this));let r=c(this,K,"f")[e];if(r&&(c(this,K,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...t))),e==="abort"){let s=t[0];!c(this,oe,"f")&&!r?.length&&Promise.reject(s),c(this,Ke,"f").call(this,s),c(this,Je,"f").call(this,s),this._emit("end");return}if(e==="error"){let s=t[0];!c(this,oe,"f")&&!r?.length&&Promise.reject(s),c(this,Ke,"f").call(this,s),c(this,Je,"f").call(this,s),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",c(this,O,"m",cr).call(this))}async _fromReadableStream(e,t){let r=t?.signal,s;r&&(r.aborted&&this.controller.abort(),s=this.controller.abort.bind(this.controller),r.addEventListener("abort",s));try{c(this,O,"m",lr).call(this),this._connected(null);let i=B.fromReadableStream(e,this.controller);for await(let o of i)c(this,O,"m",ur).call(this,o);if(i.controller.signal?.aborted)throw new S;c(this,O,"m",dr).call(this)}finally{r&&s&&r.removeEventListener("abort",s)}}[(Z=new WeakMap,Me=new WeakMap,Ge=new WeakMap,xt=new WeakMap,Ke=new WeakMap,ze=new WeakMap,_t=new WeakMap,Je=new WeakMap,K=new WeakMap,Xe=new WeakMap,Tt=new WeakMap,vt=new WeakMap,oe=new WeakMap,Et=new WeakMap,St=new WeakMap,Ye=new WeakMap,Ct=new WeakMap,O=new WeakSet,cr=function(){if(this.receivedMessages.length===0)throw new h("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},es=function(){if(this.receivedMessages.length===0)throw new h("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(t.length===0)throw new h("stream ended without producing a content block with type=text");return t.join(" ")},lr=function(){this.ended||d(this,Z,void 0,"f")},ur=function(t){if(this.ended)return;let r=c(this,O,"m",ts).call(this,t);switch(this._emit("streamEvent",t,r),t.type){case"content_block_delta":{let s=r.content.at(-1);switch(t.delta.type){case"text_delta":{s.type==="text"&&this._emit("text",t.delta.text,s.text||"");break}case"citations_delta":{s.type==="text"&&this._emit("citation",t.delta.citation,s.citations??[]);break}case"input_json_delta":{ss(s)&&s.input&&this._emit("inputJson",t.delta.partial_json,s.input);break}case"thinking_delta":{s.type==="thinking"&&this._emit("thinking",t.delta.thinking,s.thinking);break}case"signature_delta":{s.type==="thinking"&&this._emit("signature",s.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(r),this._addMessage(or(r,c(this,Me,"f"),{logger:c(this,Ye,"f")}),!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{d(this,Z,r,"f");break}case"content_block_start":case"message_delta":break}},dr=function(){if(this.ended)throw new h("stream has ended, this shouldn't happen");let t=c(this,Z,"f");if(!t)throw new h("request ended without sending any chunks");return d(this,Z,void 0,"f"),or(t,c(this,Me,"f"),{logger:c(this,Ye,"f")})},ts=function(t){let r=c(this,Z,"f");if(t.type==="message_start"){if(r)throw new h(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!r)throw new h(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return r;case"message_delta":return r.container=t.delta.container,r.stop_reason=t.delta.stop_reason,r.stop_sequence=t.delta.stop_sequence,r.usage.output_tokens=t.usage.output_tokens,r.context_management=t.context_management,t.usage.input_tokens!=null&&(r.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(r.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(r.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(r.usage.server_tool_use=t.usage.server_tool_use),r;case"content_block_start":return r.content.push(t.content_block),r;case"content_block_delta":{let s=r.content.at(t.index);switch(t.delta.type){case"text_delta":{s?.type==="text"&&(r.content[t.index]={...s,text:(s.text||"")+t.delta.text});break}case"citations_delta":{s?.type==="text"&&(r.content[t.index]={...s,citations:[...s.citations??[],t.delta.citation]});break}case"input_json_delta":{if(s&&ss(s)){let i=s[rs]||"";i+=t.delta.partial_json;let o={...s};if(Object.defineProperty(o,rs,{value:i,enumerable:!1,writable:!0}),i)try{o.input=wt(i)}catch(a){let l=new h(`Unable to parse tool parameter JSON from model. Please retry your request or adjust your prompt. Error: ${a}. JSON: ${i}`);c(this,Ct,"f").call(this,l)}r.content[t.index]=o}break}case"thinking_delta":{s?.type==="thinking"&&(r.content[t.index]={...s,thinking:s.thinking+t.delta.thinking});break}case"signature_delta":{s?.type==="thinking"&&(r.content[t.index]={...s,signature:t.delta.signature});break}default:t.delta}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("streamEvent",s=>{let i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,o)=>t.push({resolve:i,reject:o})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new B(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var ns=`You have been working on the task described above but have not yet completed it. Write a continuation summary that will allow you (or another instance of yourself) to resume work efficiently in a future context window where the conversation history will be replaced with this summary. Your summary should be structured, concise, and actionable. Include:
1. Task Overview
The user's core request and success criteria
Any clarifications or constraints they specified
2. Current State
What has been completed so far
Files created, modified, or analyzed (with paths if relevant)
Key outputs or artifacts produced
3. Important Discoveries
Technical constraints or requirements uncovered
Decisions made and their rationale
Errors encountered and how they were resolved
What approaches were tried that didn't work (and why)
4. Next Steps
Specific actions needed to complete the task
Any blockers or open questions to resolve
Priority order if multiple steps remain
5. Context to Preserve
User preferences or style requirements
Domain-specific details that aren't obvious
Any promises made to the user
Be concise but complete\u2014err on the side of including information that would prevent duplicate work or repeated mistakes. Write in a way that enables immediate resumption of the task.
Wrap your summary in <summary></summary> tags.`;var Qe,Ae,ae,T,Ze,I,z,ee,et,is,pr;function os(){let n,e;return{promise:new Promise((r,s)=>{n=r,e=s}),resolve:n,reject:e}}var Pe=class{constructor(e,t,r){Qe.add(this),this.client=e,Ae.set(this,!1),ae.set(this,!1),T.set(this,void 0),Ze.set(this,void 0),I.set(this,void 0),z.set(this,void 0),ee.set(this,void 0),et.set(this,0),d(this,T,{params:{...t,messages:structuredClone(t.messages)}},"f"),d(this,Ze,{...r,headers:f([{"x-stainless-helper":"BetaToolRunner"},r?.headers])},"f"),d(this,ee,os(),"f")}async*[(Ae=new WeakMap,ae=new WeakMap,T=new WeakMap,Ze=new WeakMap,I=new WeakMap,z=new WeakMap,ee=new WeakMap,et=new WeakMap,Qe=new WeakSet,is=async function(){let t=c(this,T,"f").params.compactionControl;if(!t||!t.enabled)return!1;let r=0;if(c(this,I,"f")!==void 0)try{let u=await c(this,I,"f");r=u.usage.input_tokens+(u.usage.cache_creation_input_tokens??0)+(u.usage.cache_read_input_tokens??0)+u.usage.output_tokens}catch{return!1}let s=t.contextTokenThreshold??1e5;if(r<s)return!1;let i=t.model??c(this,T,"f").params.model,o=t.summaryPrompt??ns,a=c(this,T,"f").params.messages;if(a[a.length-1].role==="assistant"){let u=a[a.length-1];if(Array.isArray(u.content)){let p=u.content.filter(y=>y.type!=="tool_use");p.length===0?a.pop():u.content=p}}let l=await this.client.beta.messages.create({model:i,messages:[...a,{role:"user",content:[{type:"text",text:o}]}],max_tokens:c(this,T,"f").params.max_tokens},{headers:{"x-stainless-helper":"compaction"}});if(l.content[0]?.type!=="text")throw new h("Expected text response for compaction");return c(this,T,"f").params.messages=[{role:"user",content:l.content}],!0},Symbol.asyncIterator)](){var e;if(c(this,Ae,"f"))throw new h("Cannot iterate over a consumed stream");d(this,Ae,!0,"f"),d(this,ae,!0,"f"),d(this,z,void 0,"f");try{for(;;){let t;try{if(c(this,T,"f").params.max_iterations&&c(this,et,"f")>=c(this,T,"f").params.max_iterations)break;d(this,ae,!1,"f"),d(this,z,void 0,"f"),d(this,et,(e=c(this,et,"f"),e++,e),"f"),d(this,I,void 0,"f");let{max_iterations:r,compactionControl:s,...i}=c(this,T,"f").params;if(i.stream?(t=this.client.beta.messages.stream({...i},c(this,Ze,"f")),d(this,I,t.finalMessage(),"f"),c(this,I,"f").catch(()=>{}),yield t):(d(this,I,this.client.beta.messages.create({...i,stream:!1},c(this,Ze,"f")),"f"),yield c(this,I,"f")),!await c(this,Qe,"m",is).call(this)){if(!c(this,ae,"f")){let{role:l,content:u}=await c(this,I,"f");c(this,T,"f").params.messages.push({role:l,content:u})}let a=await c(this,Qe,"m",pr).call(this,c(this,T,"f").params.messages.at(-1));if(a)c(this,T,"f").params.messages.push(a);else if(!c(this,ae,"f"))break}}finally{t&&t.abort()}}if(!c(this,I,"f"))throw new h("ToolRunner concluded without a message from the server");c(this,ee,"f").resolve(await c(this,I,"f"))}catch(t){throw d(this,Ae,!1,"f"),c(this,ee,"f").promise.catch(()=>{}),c(this,ee,"f").reject(t),d(this,ee,os(),"f"),t}}setMessagesParams(e){typeof e=="function"?c(this,T,"f").params=e(c(this,T,"f").params):c(this,T,"f").params=e,d(this,ae,!0,"f"),d(this,z,void 0,"f")}async generateToolResponse(){let e=await c(this,I,"f")??this.params.messages.at(-1);return e?c(this,Qe,"m",pr).call(this,e):null}done(){return c(this,ee,"f").promise}async runUntilDone(){if(!c(this,Ae,"f"))for await(let e of this);return this.done()}get params(){return c(this,T,"f").params}pushMessages(...e){this.setMessagesParams(t=>({...t,messages:[...t.messages,...e]}))}then(e,t){return this.runUntilDone().then(e,t)}};pr=async function(e){return c(this,z,"f")!==void 0?c(this,z,"f"):(d(this,z,rn(c(this,T,"f").params,e),"f"),c(this,z,"f"))};async function rn(n,e=n.messages.at(-1)){if(!e||e.role!=="assistant"||!e.content||typeof e.content=="string")return null;let t=e.content.filter(s=>s.type==="tool_use");return t.length===0?null:{role:"user",content:await Promise.all(t.map(async s=>{let i=n.tools.find(o=>("name"in o?o.name:o.mcp_server_name)===s.name);if(!i||!("run"in i))return{type:"tool_result",tool_use_id:s.id,content:`Error: Tool '${s.name}' not found`,is_error:!0};try{let o=s.input;"parse"in i&&i.parse&&(o=i.parse(o));let a=await i.run(o);return{type:"tool_result",tool_use_id:s.id,content:a}}catch(o){return{type:"tool_result",tool_use_id:s.id,content:`Error: ${o instanceof Error?o.message:String(o)}`,is_error:!0}}}))}}var Re=class n{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){let e=new V;for await(let t of this.iterator)for(let r of e.decode(t))yield JSON.parse(r);for(let t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new h("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new h("Attempted to iterate over a response with no body");return new n(Ue(e.body),t)}};var ke=class extends w{create(e,t){let{betas:r,...s}=e;return this._client.post("/v1/messages/batches?beta=true",{body:s,...t,headers:f([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},t?.headers])})}retrieve(e,t={},r){let{betas:s}=t??{};return this._client.get(x`/v1/messages/batches/${e}?beta=true`,{...r,headers:f([{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString()},r?.headers])})}list(e={},t){let{betas:r,...s}=e??{};return this._client.getAPIList("/v1/messages/batches?beta=true",N,{query:s,...t,headers:f([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},t?.headers])})}delete(e,t={},r){let{betas:s}=t??{};return this._client.delete(x`/v1/messages/batches/${e}?beta=true`,{...r,headers:f([{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString()},r?.headers])})}cancel(e,t={},r){let{betas:s}=t??{};return this._client.post(x`/v1/messages/batches/${e}/cancel?beta=true`,{...r,headers:f([{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString()},r?.headers])})}async results(e,t={},r){let s=await this.retrieve(e);if(!s.results_url)throw new h(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);let{betas:i}=t??{};return this._client.get(s.results_url,{...r,headers:f([{"anthropic-beta":[...i??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary"},r?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((o,a)=>Re.fromResponse(a.response,a.controller))}};var as={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-7-sonnet-latest":"February 19th, 2026","claude-3-7-sonnet-20250219":"February 19th, 2026"},te=class extends w{constructor(){super(...arguments),this.batches=new ke(this._client)}create(e,t){let{betas:r,...s}=e;s.model in as&&console.warn(`The model '${s.model}' is deprecated and will reach end-of-life on ${as[s.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let i=this._client._options.timeout;if(!s.stream&&i==null){let o=yt[s.model]??void 0;i=this._client.calculateNonstreamingTimeout(s.max_tokens,o)}return this._client.post("/v1/messages?beta=true",{body:s,timeout:i??6e5,...t,headers:f([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},t?.headers]),stream:e.stream??!1})}parse(e,t){return t={...t,headers:f([{"anthropic-beta":[...e.betas??[],"structured-outputs-2025-11-13"].toString()},t?.headers])},this.create(e,t).then(r=>ar(r,e,{logger:this._client.logger??console}))}stream(e,t){return Mt.createMessage(this,e,t)}countTokens(e,t){let{betas:r,...s}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:s,...t,headers:f([{"anthropic-beta":[...r??[],"token-counting-2024-11-01"].toString()},t?.headers])})}toolRunner(e,t){return new Pe(this._client,e,t)}};te.Batches=ke;te.BetaToolRunner=Pe;var Ie=class extends w{create(e,t={},r){let{betas:s,...i}=t??{};return this._client.post(x`/v1/skills/${e}/versions?beta=true`,ve({body:i,...r,headers:f([{"anthropic-beta":[...s??[],"skills-2025-10-02"].toString()},r?.headers])},this._client))}retrieve(e,t,r){let{skill_id:s,betas:i}=t;return this._client.get(x`/v1/skills/${s}/versions/${e}?beta=true`,{...r,headers:f([{"anthropic-beta":[...i??[],"skills-2025-10-02"].toString()},r?.headers])})}list(e,t={},r){let{betas:s,...i}=t??{};return this._client.getAPIList(x`/v1/skills/${e}/versions?beta=true`,Te,{query:i,...r,headers:f([{"anthropic-beta":[...s??[],"skills-2025-10-02"].toString()},r?.headers])})}delete(e,t,r){let{skill_id:s,betas:i}=t;return this._client.delete(x`/v1/skills/${s}/versions/${e}?beta=true`,{...r,headers:f([{"anthropic-beta":[...i??[],"skills-2025-10-02"].toString()},r?.headers])})}};var ce=class extends w{constructor(){super(...arguments),this.versions=new Ie(this._client)}create(e={},t){let{betas:r,...s}=e??{};return this._client.post("/v1/skills?beta=true",ve({body:s,...t,headers:f([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},t?.headers])},this._client))}retrieve(e,t={},r){let{betas:s}=t??{};return this._client.get(x`/v1/skills/${e}?beta=true`,{...r,headers:f([{"anthropic-beta":[...s??[],"skills-2025-10-02"].toString()},r?.headers])})}list(e={},t){let{betas:r,...s}=e??{};return this._client.getAPIList("/v1/skills?beta=true",Te,{query:s,...t,headers:f([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},t?.headers])})}delete(e,t={},r){let{betas:s}=t??{};return this._client.delete(x`/v1/skills/${e}?beta=true`,{...r,headers:f([{"anthropic-beta":[...s??[],"skills-2025-10-02"].toString()},r?.headers])})}};ce.Versions=Ie;var F=class extends w{constructor(){super(...arguments),this.models=new Se(this._client),this.messages=new te(this._client),this.files=new Ee(this._client),this.skills=new ce(this._client)}};F.Models=Se;F.Messages=te;F.Files=Ee;F.Skills=ce;var le=class extends w{create(e,t){let{betas:r,...s}=e;return this._client.post("/v1/complete",{body:s,timeout:this._client._options.timeout??6e5,...t,headers:f([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},t?.headers]),stream:e.stream??!1})}};var $,re,tt,At,rt,st,Pt,nt,J,it,Rt,kt,ue,It,Lt,hr,cs,mr,fr,gr,br,ls,us="__json_buf";function ds(n){return n.type==="tool_use"||n.type==="server_tool_use"}var Nt=class n{constructor(){$.add(this),this.messages=[],this.receivedMessages=[],re.set(this,void 0),this.controller=new AbortController,tt.set(this,void 0),At.set(this,()=>{}),rt.set(this,()=>{}),st.set(this,void 0),Pt.set(this,()=>{}),nt.set(this,()=>{}),J.set(this,{}),it.set(this,!1),Rt.set(this,!1),kt.set(this,!1),ue.set(this,!1),It.set(this,void 0),Lt.set(this,void 0),mr.set(this,e=>{if(d(this,Rt,!0,"f"),W(e)&&(e=new S),e instanceof S)return d(this,kt,!0,"f"),this._emit("abort",e);if(e instanceof h)return this._emit("error",e);if(e instanceof Error){let t=new h(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new h(String(e)))}),d(this,tt,new Promise((e,t)=>{d(this,At,e,"f"),d(this,rt,t,"f")}),"f"),d(this,st,new Promise((e,t)=>{d(this,Pt,e,"f"),d(this,nt,t,"f")}),"f"),c(this,tt,"f").catch(()=>{}),c(this,st,"f").catch(()=>{})}get response(){return c(this,It,"f")}get request_id(){return c(this,Lt,"f")}async withResponse(){d(this,ue,!0,"f");let e=await c(this,tt,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,r){let s=new n;for(let i of t.messages)s._addMessageParam(i);return s._run(()=>s._createMessage(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),s}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},c(this,mr,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,r){let s=r?.signal,i;s&&(s.aborted&&this.controller.abort(),i=this.controller.abort.bind(this.controller),s.addEventListener("abort",i));try{c(this,$,"m",fr).call(this);let{response:o,data:a}=await e.create({...t,stream:!0},{...r,signal:this.controller.signal}).withResponse();this._connected(o);for await(let l of a)c(this,$,"m",gr).call(this,l);if(a.controller.signal?.aborted)throw new S;c(this,$,"m",br).call(this)}finally{s&&i&&s.removeEventListener("abort",i)}}_connected(e){this.ended||(d(this,It,e,"f"),d(this,Lt,e?.headers.get("request-id"),"f"),c(this,At,"f").call(this,e),this._emit("connect"))}get ended(){return c(this,it,"f")}get errored(){return c(this,Rt,"f")}get aborted(){return c(this,kt,"f")}abort(){this.controller.abort()}on(e,t){return(c(this,J,"f")[e]||(c(this,J,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=c(this,J,"f")[e];if(!r)return this;let s=r.findIndex(i=>i.listener===t);return s>=0&&r.splice(s,1),this}once(e,t){return(c(this,J,"f")[e]||(c(this,J,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{d(this,ue,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){d(this,ue,!0,"f"),await c(this,st,"f")}get currentMessage(){return c(this,re,"f")}async finalMessage(){return await this.done(),c(this,$,"m",hr).call(this)}async finalText(){return await this.done(),c(this,$,"m",cs).call(this)}_emit(e,...t){if(c(this,it,"f"))return;e==="end"&&(d(this,it,!0,"f"),c(this,Pt,"f").call(this));let r=c(this,J,"f")[e];if(r&&(c(this,J,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...t))),e==="abort"){let s=t[0];!c(this,ue,"f")&&!r?.length&&Promise.reject(s),c(this,rt,"f").call(this,s),c(this,nt,"f").call(this,s),this._emit("end");return}if(e==="error"){let s=t[0];!c(this,ue,"f")&&!r?.length&&Promise.reject(s),c(this,rt,"f").call(this,s),c(this,nt,"f").call(this,s),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",c(this,$,"m",hr).call(this))}async _fromReadableStream(e,t){let r=t?.signal,s;r&&(r.aborted&&this.controller.abort(),s=this.controller.abort.bind(this.controller),r.addEventListener("abort",s));try{c(this,$,"m",fr).call(this),this._connected(null);let i=B.fromReadableStream(e,this.controller);for await(let o of i)c(this,$,"m",gr).call(this,o);if(i.controller.signal?.aborted)throw new S;c(this,$,"m",br).call(this)}finally{r&&s&&r.removeEventListener("abort",s)}}[(re=new WeakMap,tt=new WeakMap,At=new WeakMap,rt=new WeakMap,st=new WeakMap,Pt=new WeakMap,nt=new WeakMap,J=new WeakMap,it=new WeakMap,Rt=new WeakMap,kt=new WeakMap,ue=new WeakMap,It=new WeakMap,Lt=new WeakMap,mr=new WeakMap,$=new WeakSet,hr=function(){if(this.receivedMessages.length===0)throw new h("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},cs=function(){if(this.receivedMessages.length===0)throw new h("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(t.length===0)throw new h("stream ended without producing a content block with type=text");return t.join(" ")},fr=function(){this.ended||d(this,re,void 0,"f")},gr=function(t){if(this.ended)return;let r=c(this,$,"m",ls).call(this,t);switch(this._emit("streamEvent",t,r),t.type){case"content_block_delta":{let s=r.content.at(-1);switch(t.delta.type){case"text_delta":{s.type==="text"&&this._emit("text",t.delta.text,s.text||"");break}case"citations_delta":{s.type==="text"&&this._emit("citation",t.delta.citation,s.citations??[]);break}case"input_json_delta":{ds(s)&&s.input&&this._emit("inputJson",t.delta.partial_json,s.input);break}case"thinking_delta":{s.type==="thinking"&&this._emit("thinking",t.delta.thinking,s.thinking);break}case"signature_delta":{s.type==="thinking"&&this._emit("signature",s.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(r),this._addMessage(r,!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{d(this,re,r,"f");break}case"content_block_start":case"message_delta":break}},br=function(){if(this.ended)throw new h("stream has ended, this shouldn't happen");let t=c(this,re,"f");if(!t)throw new h("request ended without sending any chunks");return d(this,re,void 0,"f"),t},ls=function(t){let r=c(this,re,"f");if(t.type==="message_start"){if(r)throw new h(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!r)throw new h(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return r;case"message_delta":return r.stop_reason=t.delta.stop_reason,r.stop_sequence=t.delta.stop_sequence,r.usage.output_tokens=t.usage.output_tokens,t.usage.input_tokens!=null&&(r.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(r.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(r.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(r.usage.server_tool_use=t.usage.server_tool_use),r;case"content_block_start":return r.content.push({...t.content_block}),r;case"content_block_delta":{let s=r.content.at(t.index);switch(t.delta.type){case"text_delta":{s?.type==="text"&&(r.content[t.index]={...s,text:(s.text||"")+t.delta.text});break}case"citations_delta":{s?.type==="text"&&(r.content[t.index]={...s,citations:[...s.citations??[],t.delta.citation]});break}case"input_json_delta":{if(s&&ds(s)){let i=s[us]||"";i+=t.delta.partial_json;let o={...s};Object.defineProperty(o,us,{value:i,enumerable:!1,writable:!0}),i&&(o.input=wt(i)),r.content[t.index]=o}break}case"thinking_delta":{s?.type==="thinking"&&(r.content[t.index]={...s,thinking:s.thinking+t.delta.thinking});break}case"signature_delta":{s?.type==="thinking"&&(r.content[t.index]={...s,signature:t.delta.signature});break}default:t.delta}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("streamEvent",s=>{let i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,o)=>t.push({resolve:i,reject:o})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new B(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var Le=class extends w{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(x`/v1/messages/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/v1/messages/batches",N,{query:e,...t})}delete(e,t){return this._client.delete(x`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(x`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){let r=await this.retrieve(e);if(!r.results_url)throw new h(`No batch \`results_url\`; Has it finished processing? ${r.processing_status} - ${r.id}`);return this._client.get(r.results_url,{...t,headers:f([{Accept:"application/binary"},t?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((s,i)=>Re.fromResponse(i.response,i.controller))}};var se=class extends w{constructor(){super(...arguments),this.batches=new Le(this._client)}create(e,t){e.model in ps&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${ps[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let r=this._client._options.timeout;if(!e.stream&&r==null){let s=yt[e.model]??void 0;r=this._client.calculateNonstreamingTimeout(e.max_tokens,s)}return this._client.post("/v1/messages",{body:e,timeout:r??6e5,...t,stream:e.stream??!1})}stream(e,t){return Nt.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}},ps={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-7-sonnet-latest":"February 19th, 2026","claude-3-7-sonnet-20250219":"February 19th, 2026"};se.Batches=Le;var de=class extends w{retrieve(e,t={},r){let{betas:s}=t??{};return this._client.get(x`/v1/models/${e}`,{...r,headers:f([{...s?.toString()!=null?{"anthropic-beta":s?.toString()}:void 0},r?.headers])})}list(e={},t){let{betas:r,...s}=e??{};return this._client.getAPIList("/v1/models",N,{query:s,...t,headers:f([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},t?.headers])})}};var ot=n=>{if(typeof globalThis.process<"u")return globalThis.process.env?.[n]?.trim()??void 0;if(typeof globalThis.Deno<"u")return globalThis.Deno.env?.get?.(n)?.trim()};var yr,wr,Ot,hs,ms="\\n\\nHuman:",fs="\\n\\nAssistant:",_=class{constructor({baseURL:e=ot("ANTHROPIC_BASE_URL"),apiKey:t=ot("ANTHROPIC_API_KEY")??null,authToken:r=ot("ANTHROPIC_AUTH_TOKEN")??null,...s}={}){yr.add(this),Ot.set(this,void 0);let i={apiKey:t,authToken:r,...s,baseURL:e||"https://api.anthropic.com"};if(!i.dangerouslyAllowBrowser&&Ur())throw new h(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);this.baseURL=i.baseURL,this.timeout=i.timeout??wr.DEFAULT_TIMEOUT,this.logger=i.logger??console;let o="warn";this.logLevel=o,this.logLevel=Zt(i.logLevel,"ClientOptions.logLevel",this)??Zt(ot("ANTHROPIC_LOG"),"process.env['ANTHROPIC_LOG']",this)??o,this.fetchOptions=i.fetchOptions,this.maxRetries=i.maxRetries??2,this.fetch=i.fetch??jr(),d(this,Ot,Hr,"f"),this._options=i,this.apiKey=typeof t=="string"?t:null,this.authToken=r}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,authToken:this.authToken,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){if(!(e.get("x-api-key")||e.get("authorization"))&&!(this.apiKey&&e.get("x-api-key"))&&!t.has("x-api-key")&&!(this.authToken&&e.get("authorization"))&&!t.has("authorization"))throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}async authHeaders(e){return f([await this.apiKeyAuth(e),await this.bearerAuth(e)])}async apiKeyAuth(e){if(this.apiKey!=null)return f([{"X-Api-Key":this.apiKey}])}async bearerAuth(e){if(this.authToken!=null)return f([{Authorization:`Bearer ${this.authToken}`}])}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new h(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}getUserAgent(){return`${this.constructor.name}/JS ${Q}`}defaultIdempotencyKey(){return`stainless-node-retry-${zt()}`}makeStatusError(e,t,r,s){return v.generate(e,t,r,s)}buildURL(e,t,r){let s=!c(this,yr,"m",hs).call(this)&&r||this.baseURL,i=kr(e)?new URL(e):new URL(s+(s.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),o=this.defaultQuery();return Ir(o)||(t={...o,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(i.search=this.stringifyQuery(t)),i.toString()}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new h("Streaming is required for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(s=>({method:e,path:t,...s})))}request(e,t=null){return new ne(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,r){let s=await e,i=s.maxRetries??this.maxRetries;t==null&&(t=i),await this.prepareOptions(s);let{req:o,url:a,timeout:l}=await this.buildRequest(s,{retryCount:i-t});await this.prepareRequest(o,{url:a,options:s});let u="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),p=r===void 0?"":`, retryOf: ${r}`,y=Date.now();if(E(this).debug(`[${u}] sending request`,G({retryOfRequestLogID:r,method:s.method,url:a,options:s,headers:o.headers})),s.signal?.aborted)throw new S;let M=new AbortController,g=await this.fetchWithTimeout(a,o,l,M).catch(Fe),D=Date.now();if(g instanceof globalThis.Error){let H=`retrying, ${t} attempts remaining`;if(s.signal?.aborted)throw new S;let U=W(g)||/timed? ?out/i.test(String(g)+("cause"in g?String(g.cause):""));if(t)return E(this).info(`[${u}] connection ${U?"timed out":"failed"} - ${H}`),E(this).debug(`[${u}] connection ${U?"timed out":"failed"} (${H})`,G({retryOfRequestLogID:r,url:a,durationMs:D-y,message:g.message})),this.retryRequest(s,t,r??u);throw E(this).info(`[${u}] connection ${U?"timed out":"failed"} - error; no more retries left`),E(this).debug(`[${u}] connection ${U?"timed out":"failed"} (error; no more retries left)`,G({retryOfRequestLogID:r,url:a,durationMs:D-y,message:g.message})),U?new he:new Y({cause:g})}let Gt=[...g.headers.entries()].filter(([H])=>H==="request-id").map(([H,U])=>", "+H+": "+JSON.stringify(U)).join(""),Kt=`[${u}${p}${Gt}] ${o.method} ${a} ${g.ok?"succeeded":"failed"} with status ${g.status} in ${D-y}ms`;if(!g.ok){let H=await this.shouldRetry(g);if(t&&H){let at=`retrying, ${t} attempts remaining`;return await qr(g.body),E(this).info(`${Kt} - ${at}`),E(this).debug(`[${u}] response error (${at})`,G({retryOfRequestLogID:r,url:g.url,status:g.status,headers:g.headers,durationMs:D-y})),this.retryRequest(s,t,r??u,g.headers)}let U=H?"error; no more retries left":"error; not retryable";E(this).info(`${Kt} - ${U}`);let Mr=await g.text().catch(at=>Fe(at).message),Ar=ut(Mr),Pr=Ar?void 0:Mr;throw E(this).debug(`[${u}] response error (${U})`,G({retryOfRequestLogID:r,url:g.url,status:g.status,headers:g.headers,message:Pr,durationMs:Date.now()-y})),this.makeStatusError(g.status,Ar,Pr,g.headers)}return E(this).info(Kt),E(this).debug(`[${u}] response start`,G({retryOfRequestLogID:r,url:g.url,status:g.status,headers:g.headers,durationMs:D-y})),{response:g,options:s,controller:M,requestLogID:u,retryOfRequestLogID:r,startTime:y}}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}requestAPIList(e,t){let r=this.makeRequest(t,null,void 0);return new We(this,r,e)}async fetchWithTimeout(e,t,r,s){let{signal:i,method:o,...a}=t||{};i&&i.addEventListener("abort",()=>s.abort());let l=setTimeout(()=>s.abort(),r),u=globalThis.ReadableStream&&a.body instanceof globalThis.ReadableStream||typeof a.body=="object"&&a.body!==null&&Symbol.asyncIterator in a.body,p={signal:s.signal,...u?{duplex:"half"}:{},method:"GET",...a};o&&(p.method=o.toUpperCase());try{return await this.fetch.call(void 0,e,p)}finally{clearTimeout(l)}}async shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r,s){let i,o=s?.get("retry-after-ms");if(o){let l=parseFloat(o);Number.isNaN(l)||(i=l)}let a=s?.get("retry-after");if(a&&!i){let l=parseFloat(a);Number.isNaN(l)?i=Date.parse(a)-Date.now():i=l*1e3}if(!(i&&0<=i&&i<60*1e3)){let l=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,l)}return await Or(i),this.makeRequest(e,t-1,r)}calculateDefaultRetryTimeoutMillis(e,t){let i=t-e,o=Math.min(.5*Math.pow(2,i),8),a=1-Math.random()*.25;return o*a*1e3}calculateNonstreamingTimeout(e,t){if(36e5*e/128e3>6e5||t!=null&&e>t)throw new h("Streaming is required for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#long-requests for more details");return 6e5}async buildRequest(e,{retryCount:t=0}={}){let r={...e},{method:s,path:i,query:o,defaultBaseURL:a}=r,l=this.buildURL(i,o,a);"timeout"in r&&Nr("timeout",r.timeout),r.timeout=r.timeout??this.timeout;let{bodyHeaders:u,body:p}=this.buildBody({options:r}),y=await this.buildHeaders({options:e,method:s,bodyHeaders:u,retryCount:t});return{req:{method:s,headers:y,...r.signal&&{signal:r.signal},...globalThis.ReadableStream&&p instanceof globalThis.ReadableStream&&{duplex:"half"},...p&&{body:p},...this.fetchOptions??{},...r.fetchOptions??{}},url:l,timeout:r.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:r,retryCount:s}){let i={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let o=f([i,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(s),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...Br(),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01"},await this.authHeaders(e),this._options.defaultHeaders,r,e.headers]);return this.validateHeaders(o),o.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};let r=f([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&r.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:dt(e)}:c(this,Ot,"f").call(this,{body:e,headers:r})}};wr=_,Ot=new WeakMap,yr=new WeakSet,hs=function(){return this.baseURL!=="https://api.anthropic.com"};_.Anthropic=wr;_.HUMAN_PROMPT=ms;_.AI_PROMPT=fs;_.DEFAULT_TIMEOUT=6e5;_.AnthropicError=h;_.APIError=v;_.APIConnectionError=Y;_.APIConnectionTimeoutError=he;_.APIUserAbortError=S;_.NotFoundError=be;_.ConflictError=ye;_.RateLimitError=xe;_.BadRequestError=me;_.AuthenticationError=fe;_.InternalServerError=_e;_.PermissionDeniedError=ge;_.UnprocessableEntityError=we;_.toFile=bt;var j=class extends _{constructor(){super(...arguments),this.completions=new le(this),this.messages=new se(this),this.models=new de(this),this.beta=new F(this)}};j.Completions=le;j.Messages=se;j.Models=de;j.Beta=F;var pe=L(require("vscode")),A=class n{static{this.CONFIG_SECTION="alTestGenerator"}static initialize(){n.config=pe.workspace.getConfiguration(n.CONFIG_SECTION),pe.workspace.onDidChangeConfiguration(e=>{e.affectsConfiguration(n.CONFIG_SECTION)&&(n.config=pe.workspace.getConfiguration(n.CONFIG_SECTION))})}static getModel(){return n.config.get("model","claude-sonnet-4-5-20250929")}static getMaxTokens(){return n.config.get("maxTokens",4096)}static getTimeout(){let e=n.config.get("timeout",60);return Math.min(e,60)}static getOutputFolder(){return n.config.get("outputFolder","Test")}static getTestIdStartRange(){return n.config.get("testIdStartRange",5e4)}static shouldGenerateMocks(){return n.config.get("generateMocks",!0)}static shouldIncludeNegativeTests(){return n.config.get("includeNegativeTests",!0)}static getTestIsolation(){return n.config.get("testIsolation","Codeunit")==="Disabled"?"Disabled":"Codeunit"}static isCacheEnabled(){return n.config.get("enableCache",!0)}static getAllConfig(){return{model:n.getModel(),maxTokens:n.getMaxTokens(),timeout:n.getTimeout(),outputFolder:n.getOutputFolder(),testIdStartRange:n.getTestIdStartRange(),generateMocks:n.shouldGenerateMocks(),includeNegativeTests:n.shouldIncludeNegativeTests(),testIsolation:n.getTestIsolation(),cacheEnabled:n.isCacheEnabled()}}static async updateConfig(e,t,r=pe.ConfigurationTarget.Workspace){await n.config.update(e,t,r)}static async resetToDefaults(){let e=["model","maxTokens","timeout","outputFolder","testIdStartRange","generateMocks","includeNegativeTests","testIsolation","enableCache"];for(let t of e)await n.config.update(t,void 0,pe.ConfigurationTarget.Workspace)}};var $t=class{constructor(e){this.client=null;this.maxRetries=5;this.baseDelay=1e3;this.outputChannel=e}async initialize(){let e=await X.instance.getApiKey();if(!e)throw new Error('API-Key nicht konfiguriert. Bitte mit "AL: Set Anthropic API Key" eingeben.');this.client=new j({apiKey:e}),this.outputChannel.appendLine("Claude API Client initialisiert")}async generateTestCode(e,t,r){if(this.client||await this.initialize(),!this.client)throw new Error("Claude Client konnte nicht initialisiert werden");return await this.executeWithRetry(async()=>{let s=A.getTimeout()*1e3,i=new AbortController;r.onCancellationRequested(()=>{this.outputChannel.appendLine("API-Anfrage abgebrochen durch Benutzer"),i.abort()});let o=setTimeout(()=>{this.outputChannel.appendLine(`Timeout nach ${s/1e3} Sekunden`),i.abort()},s);try{let a=this.buildPrompt(e,t);this.outputChannel.appendLine(`
Sende Anfrage an Claude AI (${A.getModel()})...`),this.outputChannel.appendLine(`Max Tokens: ${A.getMaxTokens()}`);let l=await this.client.messages.create({model:A.getModel(),max_tokens:A.getMaxTokens(),messages:[{role:"user",content:a}]});this.outputChannel.appendLine("Response erhalten"),this.outputChannel.appendLine(`Stop Reason: ${l.stop_reason}`),this.outputChannel.appendLine(`Usage: ${JSON.stringify(l.usage)}`);let u=l.content.find(p=>p.type==="text");if(!u||u.type!=="text")throw new Error("Keine Text-Response von Claude erhalten");return this.extractCodeFromResponse(u.text)}finally{clearTimeout(o)}})}async executeWithRetry(e){let t=0,r=null;for(;t<this.maxRetries;)try{return await e()}catch(s){if(r=s,!this.isRetryableError(s)||t>=this.maxRetries-1)throw s;let o=s.headers?.["retry-after"],a=o?parseInt(o)*1e3:Math.min(this.baseDelay*Math.pow(2,t)+Math.random()*1e3,6e4);this.outputChannel.appendLine(`Fehler: ${s.message}. Retry in ${a/1e3}s (Versuch ${t+1}/${this.maxRetries})`),await this.sleep(a),t++}throw r||new Error("Max Retries \xFCberschritten")}isRetryableError(e){return e.status===429||e.status>=500&&e.status<600||e.code==="ECONNRESET"||e.code==="ETIMEDOUT"}buildPrompt(e,t){let r=A.getTestIsolation(),s=A.shouldGenerateMocks(),i=A.shouldIncludeNegativeTests();return`You are an expert in Microsoft Dynamics 365 Business Central AL development and testing.

## Task
Generate a comprehensive test codeunit for the following AL code following Microsoft's official test standards:
https://learn.microsoft.com/en-us/dynamics365/business-central/dev-itpro/developer/devenv-test-codeunits-and-test-methods
${/^(tableextension|pageextension|reportextension|enumextension)\s+\d+/mi.test(e)?`

## EXTENSION OBJECT TESTING
The source code is an extension object. Follow these guidelines:

### Testing Extensions:
1. **Test extension procedures/triggers** added to the base object
2. **Test field additions** (for TableExtensions)
3. **Test modifications** to base object behavior
4. **Test integration** with base object
5. **Use base object records** in test scenarios

### Example for TableExtension:
\`\`\`al
[Test]
procedure TestTableExtension_NewField_ValueStored()
var
    Customer: Record Customer; // Use base table
    ExpectedValue: Text;
begin
    // [SCENARIO] New field from extension stores value correctly
    
    // [GIVEN] A customer record
    Initialize();
    Customer.Init();
    Customer."No." := 'C' + LibraryRandom.RandText(10);
    ExpectedValue := 'Extension Value';
    
    // [WHEN] Setting extended field value
    Customer."Custom Field" := ExpectedValue; // Field from extension
    Customer.Insert(true);
    
    // [THEN] Value is stored correctly
    Customer.Get(Customer."No.");
    LibraryAssert.AreEqual(ExpectedValue, Customer."Custom Field", FieldValueStoredMsg);
end;
\`\`\`

### Example for PageExtension:
\`\`\`al
[Test]
procedure TestPageExtension_NewAction_Executes()
var
    CustomerCard: TestPage "Customer Card";
begin
    // [SCENARIO] New action from extension executes correctly
    
    // [GIVEN] Customer card is open
    Initialize();
    CustomerCard.OpenEdit();
    
    // [WHEN] Invoking extended action
    CustomerCard."Custom Action".Invoke(); // Action from extension
    
    // [THEN] Action completes successfully
    LibraryAssert.IsTrue(true, ActionExecutedMsg);
end;
\`\`\`
`:""}

## Source Code to Test:
\`\`\`al
${e}
\`\`\`

## Context:
${t}

## CRITICAL REQUIREMENTS (Microsoft Standards):

### 1. Test Codeunit Structure
\`\`\`al
codeunit [ID] "[Name] Test"
{
    Subtype = Test;
    TestPermissions = Disabled;

    var
        LibraryAssert: Codeunit "Library - Assert";
        LibraryRandom: Codeunit "Library - Random";
        IsInitialized: Boolean;
\`\`\`

**IMPORTANT:**
- Use \`Subtype = Test;\` (capital T, not lowercase)
- Do NOT include \`TestIsolation\` property
- Always include TestPermissions = Disabled;

### 2. MULTILINGUAL LABELS (MANDATORY)
**All error messages and labels MUST use TextConst with DEU (German) and ENU (English) translations:**

\`\`\`al
var
    CustomerCreatedMsg: Label 'Customer %1 was created successfully.', Comment = 'DEU="Debitor %1 wurde erfolgreich angelegt.",ENU="Customer %1 was created successfully."';
    InvalidEmailErr: Label 'The email address is not valid.', Comment = 'DEU="Die E-Mail-Adresse ist nicht g\xFCltig.",ENU="The email address is not valid."';
    RecordNotFoundErr: Label 'Record not found.', Comment = 'DEU="Datensatz nicht gefunden.",ENU="Record not found."';
    ValueMismatchErr: Label 'Expected value %1 but got %2.', Comment = 'DEU="Erwarteter Wert %1, erhalten %2.",ENU="Expected value %1 but got %2."';
\`\`\`

**Label Naming Convention:**
- Info messages: \`[Description]Msg\`
- Error messages: \`[Description]Err\`
- Questions: \`[Description]Qst\`
- Confirmations: \`[Description]Cnf\`

**TextConst Format:**
\`\`\`al
Label 'English text', Comment = 'DEU="Deutscher Text",ENU="English text"';
\`\`\`

**Usage in Tests:**
\`\`\`al
LibraryAssert.AreEqual(Expected, Actual, ValueMismatchErr);
LibraryAssert.IsTrue(Condition, InvalidEmailErr);
\`\`\`

### 3. OnRun Trigger (Optional Setup)
\`\`\`al
trigger OnRun()
begin
    // Shared initialization for all tests
    IsInitialized := true;
end;
\`\`\`

### 4. Test Methods Format
**MANDATORY:** Each test method MUST follow this exact structure:

\`\`\`al
[Test]
procedure Test[Feature]_[Scenario]_[ExpectedResult]()
var
    // Local variables
begin
    // [SCENARIO] Brief description of what this test does
    
    // [GIVEN] Setup and preconditions
    Initialize();
    // Setup test data
    
    // [WHEN] Execute the action being tested
    // Call the method/trigger
    
    // [THEN] Verify results with TextConst labels
    LibraryAssert.AreEqual(Expected, Actual, ValueMismatchErr);
end;
\`\`\`

### 5. Library Assert Usage (MANDATORY)
**ONLY use Library - Assert codeunit with TextConst labels:**

\`\`\`al
// Equality checks
LibraryAssert.AreEqual(Expected, Actual, ValueMismatchErr);
LibraryAssert.AreNotEqual(NotExpected, Actual, ValueShouldDifferErr);

// Boolean checks
LibraryAssert.IsTrue(Condition, ConditionFailedErr);
LibraryAssert.IsFalse(Condition, ConditionShouldBeFalseErr);

// Error handling
asserterror SomeMethod();
LibraryAssert.ExpectedError(ExpectedErrorTxt);

// Table checks
LibraryAssert.RecordIsEmpty(RecordVariable);
LibraryAssert.RecordIsNotEmpty(RecordVariable);
\`\`\`

### 6. Complete Example with TextConst Labels

\`\`\`al
codeunit 50100 "Customer Validation Test"
{
    Subtype = Test;
    TestPermissions = Disabled;

    var
        LibraryAssert: Codeunit "Library - Assert";
        LibraryRandom: Codeunit "Library - Random";
        Customer: Record Customer;
        IsInitialized: Boolean;
        // Labels with DEU and ENU
        EmailAcceptedMsg: Label 'Email was accepted', Comment = 'DEU="E-Mail wurde akzeptiert",ENU="Email was accepted"';
        EmailRejectedErr: Label 'Email format is invalid', Comment = 'DEU="E-Mail-Format ist ung\xFCltig",ENU="Email format is invalid"';
        CustomerDeletedMsg: Label 'Customer was deleted', Comment = 'DEU="Debitor wurde gel\xF6scht",ENU="Customer was deleted"';
        CustomerNotFoundErr: Label 'Customer not found', Comment = 'DEU="Debitor nicht gefunden",ENU="Customer not found"';
        NameMismatchErr: Label 'Customer name does not match', Comment = 'DEU="Debitorenname stimmt nicht \xFCberein",ENU="Customer name does not match"';

    [Test]
    procedure TestValidateEmail_ValidFormat_EmailAccepted()
    var
        ValidEmail: Text[80];
    begin
        // [SCENARIO] Valid email format should be accepted
        
        // [GIVEN] A customer with a valid email address
        Initialize();
        Customer.Init();
        Customer."No." := 'C' + LibraryRandom.RandText(10);
        ValidEmail := LibraryRandom.RandText(5) + '@test.com';
        
        // [WHEN] The email is validated
        Customer.Validate("E-Mail", ValidEmail);
        
        // [THEN] The email is accepted without errors
        LibraryAssert.AreEqual(ValidEmail, Customer."E-Mail", EmailAcceptedMsg);
    end;

    [Test]
    procedure TestValidateEmail_InvalidFormat_Error()
    begin
        // [SCENARIO] Invalid email format should raise an error
        
        // [GIVEN] A customer with an invalid email
        Initialize();
        Customer.Init();
        Customer."No." := 'C' + LibraryRandom.RandText(10);
        
        // [WHEN] [THEN] Setting invalid email should raise an error
        asserterror Customer.Validate("E-Mail", 'not-an-email');
        LibraryAssert.ExpectedError(EmailRejectedErr);
    end;

    [Test]
    [HandlerFunctions('ConfirmHandler')]
    procedure TestDeleteCustomer_WithConfirm_CustomerDeleted()
    var
        CustomerNo: Code[20];
    begin
        // [SCENARIO] Delete customer with confirmation
        
        // [GIVEN] An existing customer
        Initialize();
        CreateTestCustomer(Customer);
        CustomerNo := Customer."No.";
        
        // [WHEN] The customer is deleted with confirmation
        Customer.Delete(true);
        
        // [THEN] The customer no longer exists
        LibraryAssert.IsFalse(Customer.Get(CustomerNo), CustomerDeletedMsg);
    end;

    local procedure Initialize()
    begin
        if IsInitialized then
            exit;
        
        IsInitialized := true;
        Commit();
    end;

    local procedure CreateTestCustomer(var Cust: Record Customer)
    begin
        Cust.Init();
        Cust."No." := 'C' + LibraryRandom.RandText(10);
        Cust.Name := 'Test Customer ' + LibraryRandom.RandText(5);
        Cust.Insert(true);
    end;

    [ConfirmHandler]
    procedure ConfirmHandler(Question: Text[1024]; var Reply: Boolean)
    begin
        Reply := true;
    end;
}
\`\`\`

### 7. TestPage Usage (for Page Objects)
\`\`\`al
var
    CustomerCard: TestPage "Customer Card";
    PageOpenedMsg: Label 'Customer card opened', Comment = 'DEU="Debitorenkarte ge\xF6ffnet",ENU="Customer card opened"';
begin
    // Open page
    CustomerCard.OpenEdit();
    CustomerCard.GotoRecord(Customer);
    
    // Set fields
    CustomerCard."No.".SetValue('C001');
    CustomerCard.Name.SetValue('Test Customer');
    
    // Validate with TextConst label
    LibraryAssert.AreEqual('C001', CustomerCard."No.".Value, PageOpenedMsg);
    
    // Actions
    CustomerCard.OK().Invoke();
end;
\`\`\`

### 8. Handler Functions (when needed)
\`\`\`al
[Test]
[HandlerFunctions('MessageHandler')]
procedure TestWithMessage()
begin
    // Test that triggers Message()
end;

[MessageHandler]
procedure MessageHandler(Message: Text[1024])
var
    ExpectedMsg: Label 'Success', Comment = 'DEU="Erfolgreich",ENU="Success"';
begin
    // Verify message content
    LibraryAssert.IsTrue(StrPos(Message, ExpectedMsg) > 0, ExpectedMsg);
end;

[ConfirmHandler]
procedure ConfirmHandler(Question: Text[1024]; var Reply: Boolean)
begin
    Reply := true;
end;
\`\`\`

### 9. Test Coverage Requirements
Generate tests for:
1. **Happy Path**: Normal execution with valid data
2. **Validation**: Field validations and constraints${i?`
3. **Error Cases**: Invalid data, missing data, boundary conditions
4. **Edge Cases**: Empty values, maximum values, special characters`:""}
5. **Business Logic**: Calculations, triggers, state changes
6. **Data Integrity**: Record creation, modification, deletion

### 10. Initialize Pattern
\`\`\`al
local procedure Initialize()
begin
    if IsInitialized then
        exit;
    
    // One-time setup
    IsInitialized := true;
    Commit();
end;
\`\`\`

### 11. Mock Data Generation${s?" (ENABLED)":" (DISABLED)"}
${s?`\`\`\`al
local procedure CreateTestCustomer(var Customer: Record Customer)
begin
    Customer.Init();
    Customer."No." := LibraryRandom.RandText(10);
    Customer.Name := 'Test Customer ' + LibraryRandom.RandText(5);
    Customer."E-Mail" := LibraryRandom.RandText(5) + '@test.com';
    Customer.Insert(true);
end;
\`\`\``:"// Mock generation disabled"}

### 12. Transaction Model (for Integration Tests)
\`\`\`al
[Test]
[TransactionModel(TransactionModel::AutoRollback)]
procedure TestWithAutoRollback()
\`\`\`

## CRITICAL OUTPUT REQUIREMENTS:
1. **Complete, compilable AL code** - No placeholders, no TODOs
2. **Follow EXACT naming conventions** - Test[Feature]_[Scenario]_[ExpectedResult]
3. **Include [SCENARIO], [GIVEN], [WHEN], [THEN] comments** in EVERY test
4. **Use ONLY Library - Assert** - No custom assertion methods
5. **MANDATORY: All labels as TextConst with DEU and ENU** - Every error message, every assertion message
6. **Proper handler functions** - Include [HandlerFunctions] attribute
7. **Initialize pattern** - Use shared initialization method
8. **Clear error messages** - Use TextConst labels in all assertions

## MULTILINGUAL LABEL CHECKLIST:
- [ ] All assertion error messages use TextConst
- [ ] All labels have DEU (German) translation
- [ ] All labels have ENU (English) translation
- [ ] Label naming follows convention (Msg/Err/Qst/Cnf)
- [ ] Comment format: Comment = 'DEU="...",ENU="..."'

Generate the complete test codeunit now with multilingual TextConst labels:`}extractCodeFromResponse(e){let t=e.trim();t=t.replace(/^```al\s*/gm,""),t=t.replace(/^```\s*/gm,"");let r=t.match(/codeunit\s+\d+\s+".+?"/);if(!r)throw new Error("Keine g\xFCltige Codeunit-Deklaration in Response gefunden");let s=t.indexOf(r[0]);t=t.substring(s);let i=0,o=!1,a=!1,l=-1;for(let u=0;u<t.length;u++){let p=t[u],y=t[u+1];if(!o&&p==="/"&&y==="/"){a=!0;continue}if(a&&p===`
`){a=!1;continue}if(!a){if(p==="'"&&t[u-1]!=="\\"){o=!o;continue}if(!o){if(p==="{")i++;else if(p==="}"&&(i--,i===0)){l=u;break}}}}return l>0&&(t=t.substring(0,l+1)),t.trim()}sleep(e){return new Promise(t=>setTimeout(t,e))}async validateApiKey(){try{await this.initialize();let e=await this.client.messages.create({model:"claude-sonnet-4-5-20250929",max_tokens:10,messages:[{role:"user",content:"Hello"}]});return e.stop_reason==="end_turn"||e.stop_reason==="max_tokens"}catch(e){return this.outputChannel.appendLine(`API Key Validierung fehlgeschlagen: ${e}`),!1}}};var Dt=class{constructor(e,t,r,s,i){this.claudeService=e;this.alParser=t;this.fileHandler=r;this.idService=s;this.outputChannel=i}async generateTestForFile(e,t){try{this.outputChannel.appendLine(`
=== Generiere Test f\xFCr: ${e.fsPath} ===`);let r=await this.fileHandler.readAlFile(e),s=this.alParser.parse(r);if(!s)throw new Error("Konnte AL-Code nicht parsen");this.outputChannel.appendLine(this.alParser.getSummary(s));let i=this.buildContext(s),o=await this.claudeService.generateTestCode(r,i,t),a=await this.idService.getNextTestId(),l=o.replace(/codeunit\s+\d+/i,`codeunit ${a}`),u=await this.fileHandler.getTestFilePath(e);return await this.fileHandler.writeTestFile(u,l),await this.fileHandler.openTestFile(u),this.outputChannel.appendLine("\u2713 Test erfolgreich generiert"),!0}catch(r){let s=r instanceof Error?r.message:String(r);return this.outputChannel.appendLine(`\u2717 Fehler: ${s}`),!1}}async generateTestFromCode(e,t){try{let r=this.alParser.parse(e),s=r?this.buildContext(r):"Unknown AL Object";return await this.claudeService.generateTestCode(e,s,t)}catch(r){return this.outputChannel.appendLine(`Fehler: ${r}`),null}}buildContext(e){let t=[`Object Type: ${e.type}`,`Object ID: ${e.id}`,`Object Name: ${e.name}`];return e.extendsObject&&t.push(`Extends: ${e.extendsObject}`),t.push(`Procedures: ${e.procedures.length}`,`Triggers: ${e.triggers.length}`),e.procedures.length>0&&(t.push(`
Key Procedures:`),e.procedures.slice(0,5).forEach(r=>{let s=r.parameters.map(o=>`${o.name}: ${o.type}`).join(", "),i=r.returnType?`: ${r.returnType}`:"";t.push(`  - ${r.name}(${s})${i}`)})),e.fields&&e.fields.length>0&&(t.push(`
Fields:`),e.fields.slice(0,5).forEach(r=>{t.push(`  - ${r.name}: ${r.type}`)})),e.dependencies.length>0&&(t.push(`
Dependencies:`),e.dependencies.slice(0,5).forEach(r=>{t.push(`  - ${r}`)})),t.join(`
`)}};var P=L(require("vscode")),Ne=L(require("path"));var C=L(require("vscode")),q=L(require("path")),gs=L(require("fs")),Ft=class{constructor(e){this.outputChannel=e}async ensureTestAppStructure(e){let t=C.Uri.file(q.join(e.fsPath,"test")),r=C.Uri.file(q.join(t.fsPath,"source")),s=C.Uri.file(q.join(t.fsPath,"app.json"));try{return await C.workspace.fs.stat(s),this.outputChannel.appendLine("\u2713 Test App Struktur existiert bereits"),r}catch{return this.outputChannel.appendLine(`
=== Erstelle Test App Struktur ===`),await this.createTestAppStructure(e,t,r),r}}async createTestAppStructure(e,t,r){this.outputChannel.appendLine("1. Erstelle Ordner..."),await C.workspace.fs.createDirectory(t),await C.workspace.fs.createDirectory(r);let s=await this.readMainAppInfo(e);this.outputChannel.appendLine("2. Erstelle test/app.json..."),await this.createTestAppJson(t,s),this.outputChannel.appendLine("3. Erstelle test/launch.json..."),await this.createLaunchJson(t),this.outputChannel.appendLine("\u2713 Test App Struktur erfolgreich erstellt"),this.outputChannel.appendLine(`  - ${t.fsPath}/`),this.outputChannel.appendLine(`  - ${t.fsPath}/app.json`),this.outputChannel.appendLine(`  - ${t.fsPath}/launch.json`),this.outputChannel.appendLine(`  - ${r.fsPath}/`),C.window.showInformationMessage("Test App Struktur wurde erstellt. Bitte app.json und launch.json \xFCberpr\xFCfen.","app.json \xF6ffnen").then(i=>{if(i==="app.json \xF6ffnen"){let o=C.Uri.file(q.join(t.fsPath,"app.json"));C.workspace.openTextDocument(o).then(a=>{C.window.showTextDocument(a)})}})}async readMainAppInfo(e){let t=[q.join(e.fsPath,"app.json"),q.join(e.fsPath,"app","app.json"),q.join(e.fsPath,"src","app.json")];for(let r of t)try{let s=await gs.promises.readFile(r,"utf8"),i=JSON.parse(s);return this.outputChannel.appendLine(`\u2713 Haupt-App gefunden: ${r}`),{id:i.id||this.generateGuid(),publisher:i.publisher||"YourPublisher",name:i.name||"YourAppName",version:i.version||"1.0.0.0"}}catch{}return this.outputChannel.appendLine("\u26A0 Keine Haupt-App app.json gefunden - verwende Defaults"),{id:this.generateGuid(),publisher:"YourPublisher",name:"YourAppName",version:"1.0.0.0"}}async createTestAppJson(e,t){let r={id:this.generateGuid(),name:`${t.name} Tests`,publisher:t.publisher,version:t.version,brief:`Test App for ${t.name}`,description:`Contains test codeunits for ${t.name}`,privacyStatement:"",EULA:"",help:"",url:"",logo:"",dependencies:[{id:t.id,publisher:t.publisher,name:t.name,version:t.version},{id:"23de40a6-dfe8-4f80-80db-d70f83ce8caf",publisher:"Microsoft",name:"Test Runner",version:"22.0.0.0"},{id:"dd0be2ea-f733-4d65-bb34-a28f4624fb14",publisher:"Microsoft",name:"Library Assert",version:"22.0.0.0"},{id:"9856ae4f-d1a7-46ef-89bb-6ef056398228",publisher:"Microsoft",name:"Any",version:"22.0.0.0"}],screenshots:[],platform:"22.0.0.0",application:"22.0.0.0",idRanges:[{from:50100,to:50149}],resourceExposurePolicy:{allowDebugging:!0,allowDownloadingSource:!0,includeSourceInSymbolFile:!0},runtime:"11.0",features:["NoImplicitWith"],target:"Cloud",test:!0},s=JSON.stringify(r,null,2),i=C.Uri.file(q.join(e.fsPath,"app.json"));await C.workspace.fs.writeFile(i,Buffer.from(s,"utf8"))}async createLaunchJson(e){let r=JSON.stringify({version:"0.2.0",configurations:[{name:"Run Tests: Your own server",type:"al",request:"launch",server:"https://yourbcserver",serverInstance:"BC",authentication:"Windows",startupObjectType:"TestSuite",startupObjectId:50100,breakOnError:"All",breakOnRecordWrite:!1,launchBrowser:!1,enableLongRunningSqlStatements:!0,enableSqlInformationDebugger:!0,tenant:"default"},{name:"Run Tests: BC SaaS",type:"al",request:"launch",environmentType:"Sandbox",environmentName:"YourSandboxName",startupObjectType:"TestSuite",startupObjectId:50100,breakOnError:"All",breakOnRecordWrite:!1,launchBrowser:!1,enableLongRunningSqlStatements:!0,enableSqlInformationDebugger:!0}]},null,2),s=C.Uri.file(q.join(e.fsPath,"launch.json"));await C.workspace.fs.writeFile(s,Buffer.from(r,"utf8"))}generateGuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}async getTestSourceDirectory(e){return await this.ensureTestAppStructure(e)}};var Ut=class{constructor(e){this.outputChannel=e,this.testAppSetup=new Ft(e)}async getTestFilePath(e){let t=P.workspace.getWorkspaceFolder(e);if(!t)throw new Error("Datei ist nicht Teil eines Workspace");let r=await this.testAppSetup.getTestSourceDirectory(t.uri),i=`${Ne.basename(e.fsPath,".al")}.Test.al`;return P.Uri.file(Ne.join(r.fsPath,i))}async writeTestFile(e,t){let r=Ne.dirname(e.fsPath);try{await P.workspace.fs.createDirectory(P.Uri.file(r))}catch{}let s=new TextEncoder;await P.workspace.fs.writeFile(e,s.encode(t)),this.outputChannel.appendLine(`Test gespeichert: ${e.fsPath}`)}async readAlFile(e){let t=await P.workspace.fs.readFile(e);return new TextDecoder().decode(t)}async testFileExists(e){let t=await this.getTestFilePath(e);try{return await P.workspace.fs.stat(t),!0}catch{return!1}}async openTestFile(e){let t=await P.workspace.openTextDocument(e);await P.window.showTextDocument(t)}async getNextTestId(e){let t=A.getTestIdStartRange(),r=new P.RelativePattern(e.fsPath,"**/Test/**/*.al"),s=await P.workspace.findFiles(r),i=[];for(let o of s){let l=(await this.readAlFile(o)).match(/codeunit\s+(\d+)/i);if(l){let u=parseInt(l[1]);u>=t&&i.push(u)}}return i.length===0?t:(i.sort((o,a)=>o-a),i[i.length-1]+1)}};var Bt=class n{static{this.OBJECT_PATTERN=/(table|page|codeunit|report|query|xmlport|enum|tableextension|pageextension|reportextension|enumextension)\s+(\d+)\s+"?([^"\n{]+)"?/gi}static{this.EXTENDS_PATTERN=/extends\s+"?([^"\n{]+)"?/gi}static{this.PROCEDURE_PATTERN=/(local\s+|internal\s+|protected\s+)?(procedure)\s+(\w+)\s*\((.*?)\)(?:\s*:\s*(\w+))?/gi}static{this.TRIGGER_PATTERN=/trigger\s+(On\w+)\s*\(/gi}static{this.FIELD_PATTERN=/field\s*\(\s*(\d+)\s*;\s*"?([^";]+)"?\s*;\s*(\w+)/gi}static{this.VAR_PATTERN=/(\w+)\s*:\s*(Record|Codeunit|Page|Report|Query|Integer|Text|Boolean|Decimal|Date|Time|DateTime|Duration|Option)\s*[";]/gi}parse(e){let t=n.OBJECT_PATTERN.exec(e);if(!t)return null;n.OBJECT_PATTERN.lastIndex=0;let r={type:t[1].toLowerCase(),id:parseInt(t[2]),name:t[3].trim(),procedures:this.extractProcedures(e),triggers:this.extractTriggers(e),variables:this.extractVariables(e),dependencies:this.extractDependencies(e)};if(["tableextension","pageextension","reportextension","enumextension"].includes(r.type)){let i=n.EXTENDS_PATTERN.exec(e);i&&(r.extendsObject=i[1].trim()),n.EXTENDS_PATTERN.lastIndex=0}return(r.type==="table"||r.type==="tableextension")&&(r.fields=this.extractFields(e)),r}extractProcedures(e){let t=[],r;for(;(r=n.PROCEDURE_PATTERN.exec(e))!==null;)t.push({name:r[3],parameters:this.parseParameters(r[4]),returnType:r[5],isLocal:!!r[1]?.includes("local"),attributes:this.extractAttributesAbove(e,r.index)});return n.PROCEDURE_PATTERN.lastIndex=0,t}parseParameters(e){if(!e||e.trim()==="")return[];let t=[],r=e.split(";").map(s=>s.trim()).filter(s=>s);for(let s of r){let i=s.toLowerCase().startsWith("var "),o=i?s.substring(4).trim():s,a=o.indexOf(":");if(a>0){let l=o.substring(0,a).trim(),u=o.substring(a+1).trim();t.push({name:l,type:u,isVar:i})}}return t}extractTriggers(e){let t=[],r;for(;(r=n.TRIGGER_PATTERN.exec(e))!==null;)t.push({name:r[1]});return n.TRIGGER_PATTERN.lastIndex=0,t}extractFields(e){let t=[],r;for(;(r=n.FIELD_PATTERN.exec(e))!==null;)t.push({id:parseInt(r[1]),name:r[2].trim(),type:r[3]});return n.FIELD_PATTERN.lastIndex=0,t}extractVariables(e){let t=[],r;for(;(r=n.VAR_PATTERN.exec(e))!==null;)t.push({name:r[1],type:r[2]});return n.VAR_PATTERN.lastIndex=0,t}extractDependencies(e){let t=new Set,r=/(\w+)\s*:\s*Record\s+"?([^";]+)"?/gi,s;for(;(s=r.exec(e))!==null;)t.add(`Table: ${s[2]}`);let i=/Codeunit\.Run\s*\(\s*Codeunit::"?([^")]+)"?/gi;for(;(s=i.exec(e))!==null;)t.add(`Codeunit: ${s[1]}`);let o=/Page\.Run\s*\(\s*Page::"?([^")]+)"?/gi;for(;(s=o.exec(e))!==null;)t.add(`Page: ${s[1]}`);return Array.from(t)}extractAttributesAbove(e,t){let r=[],s=e.substring(Math.max(0,t-500),t).split(`
`);for(let i=s.length-1;i>=0;i--){let o=s[i].trim();if(o.startsWith("[")&&o.endsWith("]"))r.unshift(o);else if(o&&!o.startsWith("//"))break}return r}toJSON(e){return JSON.stringify(e,null,2)}getSummary(e){return`${e.type} ${e.id} "${e.name}"
- Procedures: ${e.procedures.length}
- Triggers: ${e.triggers.length}
- Variables: ${e.variables.length}
- Dependencies: ${e.dependencies.length}
${e.fields?`- Fields: ${e.fields.length}`:""}`}};var xr=L(require("vscode")),jt=class n{static{this.ID_KEY="al-ai-test-generator.currentTestId"}constructor(e,t){this.context=e,this.outputChannel=t}async getNextTestId(){let e=this.context.workspaceState.get(n.ID_KEY);if(e===void 0&&(e=await this.promptForStartId(),e===void 0))throw new Error("Keine Test-ID angegeben");let t=e+1;return await this.context.workspaceState.update(n.ID_KEY,t),this.outputChannel.appendLine(`Test-ID verwendet: ${e}`),e}async promptForStartId(){let e=await xr.window.showInputBox({prompt:"Geben Sie die Start-ID f\xFCr Test-Codeunits ein",placeHolder:"z.B. 50100",validateInput:r=>{let s=parseInt(r);return isNaN(s)?"Bitte geben Sie eine g\xFCltige Zahl ein":s<5e4||s>99999?"ID sollte zwischen 50000 und 99999 liegen":null}});if(!e)return;let t=parseInt(e);return this.outputChannel.appendLine(`Start-ID gesetzt: ${t}`),t}async resetTestId(){await this.context.workspaceState.update(n.ID_KEY,void 0),this.outputChannel.appendLine("Test-ID Counter zur\xFCckgesetzt"),xr.window.showInformationMessage("Test-ID Counter wurde zur\xFCckgesetzt. Bei der n\xE4chsten Test-Generierung werden Sie nach einer neuen Start-ID gefragt.")}getCurrentTestId(){return this.context.workspaceState.get(n.ID_KEY)}async setTestId(e){await this.context.workspaceState.update(n.ID_KEY,e),this.outputChannel.appendLine(`Test-ID manuell gesetzt: ${e}`)}};var $e=L(require("vscode")),De=L(require("path"));var _r=class{constructor(){this.name="AOR";this.description="Arithmetic Operator Replacement";this.category="arithmetic";this.mutations=new Map([["+",["-","*","/"]],["-",["+","*","/"]],["*",["+","-","/"]],["/",["+","-","*"]],["div",["mod"]],["mod",["div"]]])}apply(e,t){let r=e.split(`
`),s=r[t.line];for(let[i,o]of this.mutations){let a=new RegExp(`\\b${this.escapeRegex(i)}\\b`,"g"),l=a.exec(s);if(l&&l.index>=t.column&&l.index<t.column+t.length)for(let u of o){let p=s.replace(a,u);return r[t.line]=p,{code:r.join(`
`),mutation:{operator:this.name,original:i,mutated:u,line:t.line},location:t}}}return null}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},Tr=class{constructor(){this.name="ROR";this.description="Relational Operator Replacement";this.category="relational";this.mutations=new Map([[">",[">=","<","<=","=","<>"]],[">=",[">","<","<=","=","<>"]],["<",["<=",">",">=","=","<>"]],["<=",["<",">",">=","=","<>"]],["=",["<>",">","<"]],["<>",["=",">","<"]]])}apply(e,t){let r=e.split(`
`),s=r[t.line];for(let[i,o]of this.mutations){let a=new RegExp(this.escapeRegex(i),"g"),l=a.exec(s);if(l&&l.index>=t.column&&l.index<t.column+t.length)for(let u of o){let p=s.replace(a,u);return r[t.line]=p,{code:r.join(`
`),mutation:{operator:this.name,original:i,mutated:u,line:t.line},location:t}}}return null}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},vr=class{constructor(){this.name="LCR";this.description="Logical Connector Replacement";this.category="logical";this.mutations=new Map([["and",["or"]],["or",["and"]],["not",[""]]])}apply(e,t){let r=e.split(`
`),s=r[t.line];for(let[i,o]of this.mutations){let a=new RegExp(`\\b${i}\\b`,"gi"),l=a.exec(s);if(l&&l.index>=t.column&&l.index<t.column+t.length)for(let u of o){let p=s.replace(a,u);return r[t.line]=p,{code:r.join(`
`),mutation:{operator:this.name,original:i,mutated:u||"[removed]",line:t.line},location:t}}}return null}},Er=class{constructor(){this.name="SDL";this.description="Statement Deletion";this.category="statement"}apply(e,t){let r=e.split(`
`),s=r[t.line].trim();if(s.startsWith("var ")||s.startsWith("begin")||s.startsWith("end")||s.length===0)return null;let i=r[t.line];return r[t.line]="",{code:r.join(`
`),mutation:{operator:this.name,original:i.trim(),mutated:"[deleted]",line:t.line},location:t}}},Sr=class{constructor(){this.name="RVR";this.description="Return Value Replacement";this.category="value";this.mutations=new Map([["true",["false"]],["false",["true"]],["0",["1","-1"]],["1",["0","-1"]],["''",["'MUTATED'"]]])}apply(e,t){let r=e.split(`
`),s=r[t.line],i=s.match(/exit\s*\(\s*([^)]+)\s*\)/i);if(i){let o=i[1].trim();for(let[a,l]of this.mutations)if(o===a)for(let u of l){let p=s.replace(i[0],`exit(${u})`);return r[t.line]=p,{code:r.join(`
`),mutation:{operator:this.name,original:`exit(${a})`,mutated:`exit(${u})`,line:t.line},location:t}}}return null}},Cr=class{constructor(){this.name="BVR";this.description="Boundary Value Replacement";this.category="boundary"}apply(e,t){let r=e.split(`
`),s=r[t.line],i=s.match(/\b(\d+)\b/);if(i){let o=i[1],a=parseInt(o),l=[(a+1).toString(),(a-1).toString(),a!==0?"0":"1"];for(let u of l){let p=s.replace(new RegExp(`\\b${o}\\b`),u);return r[t.line]=p,{code:r.join(`
`),mutation:{operator:this.name,original:o,mutated:u,line:t.line},location:t}}}return null}},Oe=class{constructor(e){this.outputChannel=e,this.operators=[new _r,new Tr,new vr,new Er,new Sr,new Cr]}generateMutants(e){let t=[],r=e.split(`
`);this.outputChannel.appendLine(`
=== Generating Mutants ===`);for(let s=0;s<r.length;s++){let i=r[s];if(i.trim().startsWith("//")||i.trim().length===0)continue;let o={line:s,column:0,length:i.length};for(let a of this.operators){let l=a.apply(e,o);l&&(t.push(l),this.outputChannel.appendLine(`Mutant #${t.length}: ${a.name} at line ${s+1}: ${l.mutation.original} \u2192 ${l.mutation.mutated}`))}}return this.outputChannel.appendLine(`
Total mutants generated: ${t.length}`),t}calculateMutationScore(e){let t=e.length,r=e.filter(p=>p.status==="killed").length,s=e.filter(p=>p.status==="survived").length,i=e.filter(p=>p.status==="timeout").length,o=e.filter(p=>p.status==="error").length,a=t-o,l=a>0?(r+i)/a*100:0,u=t>0?r/t*100:0;return{totalMutants:t,killedMutants:r,survivedMutants:s,timeoutMutants:i,errorMutants:o,score:Math.round(u*100)/100,mutationScoreIndicator:Math.round(l*100)/100}}getOperators(){return this.operators}setActiveOperators(e){let t=[];for(let r of e){let s=this.operators.find(i=>i.name===r);s&&t.push(s)}t.length>0&&(this.operators=t,this.outputChannel.appendLine(`Active operators: ${t.map(r=>r.name).join(", ")}`))}};var qt=class{constructor(e){this.outputChannel=e,this.engine=new Oe(e)}async runMutationTests(e,t,r,s){this.outputChannel.appendLine(`
\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557`),this.outputChannel.appendLine("\u2551     MUTATION TESTING STARTED             \u2551"),this.outputChannel.appendLine(`\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D
`);let i=await this.readFile(e);r.enabledOperators.length>0&&this.engine.setActiveOperators(r.enabledOperators);let o=this.engine.generateMutants(i);if(o.length===0)return this.outputChannel.appendLine("\u26A0\uFE0F  No mutants generated. Code might be too simple."),[];this.outputChannel.appendLine(`
\u{1F4CA} Generated ${o.length} mutants`),this.outputChannel.appendLine("\u2699\uFE0F  Configuration:"),this.outputChannel.appendLine(`   - Timeout: ${r.testTimeout}ms`),this.outputChannel.appendLine(`   - Parallel: ${r.parallelExecution}`),this.outputChannel.appendLine(`   - Operators: ${r.enabledOperators.join(", ")}
`);let a=[];r.parallelExecution?a.push(...await this.runParallel(o,e,t,r,s)):a.push(...await this.runSequential(o,e,t,r,s));let l=this.engine.calculateMutationScore(a);return this.displayMutationScore(l),a}async runSequential(e,t,r,s,i){let o=[];for(let a=0;a<e.length;a++){if(i.isCancellationRequested){this.outputChannel.appendLine(`
\u274C Mutation testing cancelled by user`);break}let l=e[a],u=`M${a+1}`;this.outputChannel.appendLine(`
[${a+1}/${e.length}] Testing mutant ${u}...`),this.outputChannel.appendLine(`   Mutation: ${l.mutation.operator} at line ${l.mutation.line+1}`),this.outputChannel.appendLine(`   ${l.mutation.original} \u2192 ${l.mutation.mutated}`);let p=await this.testMutant(u,l,t,r,s);if(o.push(p),this.displayMutantResult(p),s.stopOnFirstSurvivor&&p.status==="survived"){this.outputChannel.appendLine(`
\u26A0\uFE0F  Stop on first survivor enabled. Stopping...`);break}}return o}async runParallel(e,t,r,s,i){let o=[],a=s.maxParallelMutants;for(let l=0;l<e.length;l+=a){if(i.isCancellationRequested){this.outputChannel.appendLine(`
\u274C Mutation testing cancelled`);break}let u=e.slice(l,Math.min(l+a,e.length));this.outputChannel.appendLine(`
\u{1F4E6} Processing batch ${Math.floor(l/a)+1} (${u.length} mutants)...`);let p=await Promise.all(u.map((y,M)=>{let g=`M${l+M+1}`;return this.testMutant(g,y,t,r,s)}));o.push(...p),p.forEach(y=>this.displayMutantResult(y))}return o}async testMutant(e,t,r,s,i){let o=Date.now();try{let a=await this.writeMutantFile(r,t.code),l=await this.runTests(a,s,i.testTimeout);await this.deleteFile(a);let u=Date.now()-o;return l?{mutantId:e,status:"survived",executionTime:u}:{mutantId:e,status:"killed",killedBy:["TestSuite"],executionTime:u}}catch(a){let l=Date.now()-o;return l>=i.testTimeout?{mutantId:e,status:"timeout",executionTime:l,errorMessage:"Test execution timeout"}:{mutantId:e,status:"error",executionTime:l,errorMessage:a.message}}}async runTests(e,t,r){return await this.sleep(Math.random()*500),Math.random()>.8}async writeMutantFile(e,t){let r=De.dirname(e.fsPath),s=De.basename(e.fsPath,".al"),i=De.join(r,`.${s}.mutant.al`),o=$e.Uri.file(i),a=new TextEncoder;return await $e.workspace.fs.writeFile(o,a.encode(t)),o}async deleteFile(e){try{await $e.workspace.fs.delete(e)}catch{}}async readFile(e){let t=await $e.workspace.fs.readFile(e);return new TextDecoder().decode(t)}displayMutantResult(e){let t=this.getStatusIcon(e.status),r=e.status.toUpperCase(),s=`${e.executionTime}ms`;this.outputChannel.appendLine(`   ${t} ${r} (${s})`),e.status==="killed"&&e.killedBy?this.outputChannel.appendLine(`      Killed by: ${e.killedBy.join(", ")}`):e.errorMessage&&this.outputChannel.appendLine(`      Error: ${e.errorMessage}`)}displayMutationScore(e){this.outputChannel.appendLine(`
\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557`),this.outputChannel.appendLine("\u2551        MUTATION TESTING RESULTS          \u2551"),this.outputChannel.appendLine(`\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D
`),this.outputChannel.appendLine("\u{1F4CA} Mutation Statistics:"),this.outputChannel.appendLine(`   Total Mutants:     ${e.totalMutants}`),this.outputChannel.appendLine(`   \u2713 Killed:          ${e.killedMutants} (${this.percentage(e.killedMutants,e.totalMutants)}%)`),this.outputChannel.appendLine(`   \u2717 Survived:        ${e.survivedMutants} (${this.percentage(e.survivedMutants,e.totalMutants)}%)`),this.outputChannel.appendLine(`   \u23F1  Timeout:         ${e.timeoutMutants} (${this.percentage(e.timeoutMutants,e.totalMutants)}%)`),this.outputChannel.appendLine(`   \u26A0\uFE0F  Error:           ${e.errorMutants} (${this.percentage(e.errorMutants,e.totalMutants)}%)`),this.outputChannel.appendLine(`
\u{1F3AF} Mutation Score: ${e.score}%`),this.outputChannel.appendLine(`\u{1F4C8} Mutation Score Indicator: ${e.mutationScoreIndicator}%`);let t=this.getQualityRating(e.mutationScoreIndicator);this.outputChannel.appendLine(`
${t.icon} Test Quality: ${t.text}`),e.survivedMutants>0&&this.outputChannel.appendLine(`
\u26A0\uFE0F  ${e.survivedMutants} mutant(s) survived. Consider improving test coverage!`)}getStatusIcon(e){switch(e){case"killed":return"\u2705";case"survived":return"\u274C";case"timeout":return"\u23F1\uFE0F";case"error":return"\u26A0\uFE0F";default:return"\u2753"}}percentage(e,t){return t===0?"0.00":(e/t*100).toFixed(2)}getQualityRating(e){return e>=80?{icon:"\u{1F31F}",text:"Excellent"}:e>=60?{icon:"\u{1F44D}",text:"Good"}:e>=40?{icon:"\u{1F44C}",text:"Fair"}:e>=20?{icon:"\u26A0\uFE0F",text:"Poor"}:{icon:"\u274C",text:"Very Poor"}}sleep(e){return new Promise(t=>setTimeout(t,e))}};var Wt=L(require("vscode")),Vt=L(require("path")),Ht=class{async generateHtmlReport(e,t,r,s){let i=this.buildHtmlReport(e,t,r),o=Vt.join(s.fsPath,"mutation-report.html"),a=Wt.Uri.file(o),l=new TextEncoder;return await Wt.workspace.fs.writeFile(a,l.encode(i)),a}buildHtmlReport(e,t,r){return`<!DOCTYPE html>
<html>
<head>
    <title>Mutation Testing Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; }
        .header { text-align: center; border-bottom: 3px solid #2196F3; padding-bottom: 20px; }
        .score { font-size: 48px; font-weight: bold; color: ${this.getScoreColor(t.mutationScoreIndicator)}; }
        .stats { display: flex; justify-content: space-around; margin: 30px 0; }
        .stat { text-align: center; }
        .stat-value { font-size: 36px; font-weight: bold; }
        .mutants { margin-top: 30px; }
        .mutant { padding: 15px; margin: 10px 0; border-left: 4px solid; }
        .killed { background: #e8f5e9; border-color: #4caf50; }
        .survived { background: #ffebee; border-color: #f44336; }
        .timeout { background: #fff3e0; border-color: #ff9800; }
        .error { background: #f3e5f5; border-color: #9c27b0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Mutation Testing Report</h1>
            <p>${Vt.basename(r.fsPath)}</p>
            <div class="score">${t.mutationScoreIndicator}%</div>
            <p>Mutation Score Indicator</p>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" style="color: #4caf50;">${t.killedMutants}</div>
                <div>Killed</div>
            </div>
            <div class="stat">
                <div class="stat-value" style="color: #f44336;">${t.survivedMutants}</div>
                <div>Survived</div>
            </div>
            <div class="stat">
                <div class="stat-value" style="color: #ff9800;">${t.timeoutMutants}</div>
                <div>Timeout</div>
            </div>
            <div class="stat">
                <div class="stat-value">${t.totalMutants}</div>
                <div>Total</div>
            </div>
        </div>
        
        <div class="mutants">
            <h2>Mutant Details</h2>
            ${e.map((s,i)=>this.renderMutant(s,i+1)).join("")}
        </div>
    </div>
</body>
</html>`}renderMutant(e,t){return`<div class="mutant ${e.status}">
            <strong>#${t} ${e.mutantId}</strong> - ${e.status.toUpperCase()}
            <div style="margin-top: 5px; color: #666;">
                Execution time: ${e.executionTime}ms
                ${e.killedBy?`<br>Killed by: ${e.killedBy.join(", ")}`:""}
                ${e.errorMessage?`<br>Error: ${e.errorMessage}`:""}
            </div>
        </div>`}getScoreColor(e){return e>=80?"#4caf50":e>=60?"#8bc34a":e>=40?"#ff9800":"#f44336"}};var b,bs,ys;async function un(n){console.log("AL AI Test Generator v2.1 (with Mutation Testing) aktiviert"),b=m.window.createOutputChannel("AL AI Test Generator"),b.appendLine("=============================================="),b.appendLine("AL AI Test Generator v2.1 ACTIVATED"),b.appendLine("=============================================="),b.appendLine("Extension aktiviert mit Mutation Testing Support"),b.appendLine("Commands verf\xFCgbar:"),b.appendLine("  - AL: Generate Tests with AI"),b.appendLine("  - AL: Run Mutation Tests"),b.appendLine("  - AL: Set Anthropic API Key"),b.appendLine("  - AL: Configure Mutation Testing"),b.appendLine("  - AL: Reset Test ID Counter"),b.appendLine("=============================================="),b.show(),X.initialize(n),A.initialize();let e=new $t(b),t=new Bt,r=new Ut(b),s=new jt(n,b);ys=new Dt(e,t,r,s,b),bs=new qt(b),n.subscriptions.push(m.commands.registerCommand("alTestGenerator.generateTests",dn),m.commands.registerCommand("alTestGenerator.setApiKey",ws),m.commands.registerCommand("alTestGenerator.runMutationTests",pn),m.commands.registerCommand("alTestGenerator.configureMutationTesting",hn),m.commands.registerCommand("alTestGenerator.resetTestId",()=>gn(s))),b.appendLine("\u2705 Alle Commands erfolgreich registriert"),b.appendLine("\u2705 Kontextmen\xFC f\xFCr AL-Dateien aktiv"),b.appendLine("\u27A1\uFE0F  Rechtsklick auf .al Datei f\xFCr Optionen"),m.window.showInformationMessage("AL AI Test Generator v2.1 bereit!")}async function dn(n){try{b.appendLine(`
=== Starting Test Generation ===`);let e=n||m.window.activeTextEditor?.document.uri;if(!e||!e.fsPath.endsWith(".al")){m.window.showErrorMessage("Bitte w\xE4hlen Sie eine AL-Datei aus"),b.appendLine("\u274C Keine AL-Datei ausgew\xE4hlt");return}if(b.appendLine(`\u{1F4C4} Source File: ${e.fsPath}`),!await X.instance.getApiKey()){await m.window.showErrorMessage("Kein API-Key gefunden. Bitte setzen Sie zuerst Ihren Anthropic API-Key.","API-Key setzen")&&await ws();return}if(b.appendLine("\u2705 API-Key gefunden"),await m.window.withProgress({location:m.ProgressLocation.Notification,title:"Generiere Tests mit AI...",cancellable:!0},async(s,i)=>{s.report({increment:0,message:"Analysiere Code..."}),s.report({increment:30,message:"Generiere Tests..."});let o=await ys.generateTestForFile(e,i);return s.report({increment:100,message:"Fertig!"}),o})){let s=m.Uri.joinPath(e,".."),i=m.Uri.joinPath(s,"Test"),o=e.fsPath.split("/").pop()?.replace(".al","")||"Test",a=m.Uri.joinPath(i,`${o}.Test.al`);b.appendLine(`\u2705 Test-Datei erstellt: ${a.fsPath}`),m.window.showInformationMessage("Tests erfolgreich generiert!","Datei \xF6ffnen","Test-Ordner \xF6ffnen").then(l=>{l==="Datei \xF6ffnen"?m.workspace.openTextDocument(a).then(u=>{m.window.showTextDocument(u)},u=>{b.appendLine("\u26A0\uFE0F  Test-Datei konnte nicht ge\xF6ffnet werden")}):l==="Test-Ordner \xF6ffnen"&&m.commands.executeCommand("revealInExplorer",i)})}else m.window.showWarningMessage("Test-Generierung wurde abgebrochen oder ist fehlgeschlagen")}catch(e){let t=e instanceof Error?e.message:String(e);b.appendLine(`\u274C Fehler: ${t}`),m.window.showErrorMessage(`Test-Generierung fehlgeschlagen: ${t}`)}}async function ws(){let n=await m.window.showInputBox({prompt:"Geben Sie Ihren Anthropic API-Key ein",password:!0,placeHolder:"sk-ant-..."});n&&(await X.instance.storeApiKey(n),m.window.showInformationMessage("API-Key gespeichert"))}async function pn(n){try{let e=n||m.window.activeTextEditor?.document.uri;if(!e||!e.fsPath.endsWith(".al")){m.window.showErrorMessage("Bitte w\xE4hlen Sie eine AL-Datei aus");return}let t=await mn(e);if(!t){m.window.showErrorMessage("Keine Test-Datei gefunden. Generieren Sie zuerst Tests.");return}b.show(),await m.window.withProgress({location:m.ProgressLocation.Notification,title:"Running Mutation Tests...",cancellable:!0},async(r,s)=>{let i=fn(),o=await bs.runMutationTests(e,t,i,s);if(o.length>0){let l=new Oe(b).calculateMutationScore(o),u=new Ht,p=m.workspace.getWorkspaceFolder(e);if(p){let y=m.Uri.joinPath(p.uri,"mutation-report");await m.workspace.fs.createDirectory(y);let M=await u.generateHtmlReport(o,l,e,y);await m.window.showInformationMessage(`Mutation Score: ${l.mutationScoreIndicator}%`,"Open Report")&&await m.env.openExternal(M)}}})}catch(e){let t=e instanceof Error?e.message:String(e);m.window.showErrorMessage(`Mutation Testing failed: ${t}`)}}async function hn(){let n=m.workspace.getConfiguration("alTestGenerator.mutation"),e=await m.window.showQuickPick(["AOR","ROR","LCR","SDL","RVR","BVR"],{canPickMany:!0,placeHolder:"Select enabled mutation operators",title:"Configure Mutation Testing"});e&&(await n.update("enabledOperators",e,m.ConfigurationTarget.Workspace),m.window.showInformationMessage(`Enabled operators: ${e.join(", ")}`))}async function mn(n){let e=m.Uri.joinPath(n,".."),t=m.Uri.joinPath(e,"Test"),r=n.fsPath.split("/").pop()?.replace(".al",""),s=m.Uri.joinPath(t,`${r}.Test.al`);try{return await m.workspace.fs.stat(s),s}catch{return null}}function fn(){let n=m.workspace.getConfiguration("alTestGenerator.mutation");return{testTimeout:n.get("timeout")||3e4,parallelExecution:n.get("parallelExecution")||!0,maxParallelMutants:5,stopOnFirstSurvivor:!1,enabledOperators:n.get("enabledOperators")||["AOR","ROR","LCR","SDL","RVR","BVR"]}}async function gn(n){try{await m.window.showWarningMessage("M\xF6chten Sie wirklich den Test-ID Counter zur\xFCcksetzen? Bei der n\xE4chsten Test-Generierung werden Sie nach einer neuen Start-ID gefragt.","Ja","Nein")==="Ja"&&(await n.resetTestId(),m.window.showInformationMessage("Test-ID Counter wurde zur\xFCckgesetzt"))}catch(e){b.appendLine(`Fehler beim Zur\xFCcksetzen: ${e}`),m.window.showErrorMessage("Fehler beim Zur\xFCcksetzen des Test-ID Counters")}}function bn(){b&&b.dispose()}0&&(module.exports={activate,deactivate});
